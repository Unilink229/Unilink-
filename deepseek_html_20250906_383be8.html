<!DOCTYPE html>
<html lang="zh" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>留学中｜留学生活 · 交易与社区</title>
  <meta name="description" content="Unilink：留学生生活一站式平台。真实交易、社区交流、院校评价、常用服务。">
  <meta name="keywords" content="Unilink, 留学生, 二手交易, 跑腿, 代购, 校园, 社区, 院校评价, 留学生活">
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{ --brand:#1d1d1f; --ink:#1d1d1f; --sub:#6e6e73; --line:#d2d2d7; --bg:#ffffff; --bg-alt:#f5f5f7; --radius:20px; --ease:cubic-bezier(.2,.7,.2,1) }
    html,body{background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display','SF Pro Text','Helvetica Neue',Arial,sans-serif;scroll-behavior:smooth}
    .container-apple{max-width:1200px;margin:0 auto;padding:0 24px}
    .glass{backdrop-filter:saturate(180%) blur(20px);background:rgba(255,255,255,.82)}
    .eyebrow{letter-spacing:.08em;text-transform:uppercase;font-size:12px;color:var(--sub);font-weight:700}
    .h1{font-size:64px;line-height:1.02;letter-spacing:-.02em;font-weight:800}
    .h2{font-size:36px;line-height:1.1;letter-spacing:-.01em;font-weight:700}
    .sub{font-size:17px;color:var(--sub)}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:14px 22px;border-radius:999px;font-weight:600;transition:transform .2s var(--ease),box-shadow .3s var(--ease),background .3s var(--ease)}
    .btn-black{background:var(--brand);color:#fff}
    .btn-black:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.15)}
    .btn-outline{border:1px solid var(--brand);color:var(--brand);background:#fff}
    .btn-outline:hover{background:var(--brand);color:#fff;transform:translateY(-2px)}
    .tile{border-radius:var(--radius);border:1px solid var(--line);background:#fff;transition:transform .25s var(--ease),box-shadow .3s var(--ease),border-color .2s var(--ease)}
    .tile:hover{transform:translateY(-4px);box-shadow:0 16px 40px rgba(0,0,0,.06);border-color:#bcbcc2}
    .hero{position:relative;overflow:hidden;background:linear-gradient(180deg,#fff,#f7f7f9)}
    .hero-inner{position:relative;z-index:2;padding:120px 0;text-align:center;color:var(--ink)}
    .brand-badge{display:inline-flex;align-items:center;gap:8px;background:rgba(0,0,0,.04);backdrop-filter:saturate(160%) blur(6px);border:1px solid #e5e5ea;border-radius:14px;padding:8px 12px;color:var(--ink)}
    .brand-badge .dot{width:8px;height:8px;border-radius:50%;background:var(--brand)}
    .drawer{position:fixed;right:0;top:0;height:100vh;width:360px;max-width:92vw;background:#fff;border-left:1px solid var(--line);box-shadow:-20px 0 60px rgba(0,0,0,.12);transform:translateX(100%);transition:transform .3s var(--ease);z-index:70;overflow-y:auto;-webkit-overflow-scrolling:touch}
    .drawer.active{transform:translateX(0)}
    .drawer header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line)}
    @keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .fade{animation:fadeUp .6s var(--ease) both}
    .d1{animation-delay:.08s}.d2{animation-delay:.16s}.d3{animation-delay:.24s}
    :focus-visible{outline:3px solid #2688ff; outline-offset:2px; border-radius:10px}
    .table-wrap{overflow:auto}
    @media (max-width:1024px){.h1{font-size:44px}.h2{font-size:28px}.hero-inner{padding:96px 0}}
    @media (max-width:640px){.h1{font-size:34px}.h2{font-size:22px}.hero-inner{padding:72px 0}}
    .seg{display:inline-flex;background:#fff;border:1px solid var(--line);border-radius:999px;padding:4px}
    .seg input{position:absolute;opacity:0;pointer-events:none}
    .seg label{position:relative;cursor:pointer;min-width:90px;text-align:center;padding:8px 14px;border-radius:999px;font-weight:600;color:var(--sub);transition:all .2s var(--ease)}
    .seg input:checked + label{background:var(--brand);color:#fff;box-shadow:0 6px 16px rgba(0,0,0,.12)}
    .seg label:hover{color:#111}
    .country-dropdown{position:relative;min-width:140px}
    .country-dropdown select{width:100%;padding:10px 16px;border-radius:12px;border:1px solid var(--line);appearance:none;background:white;font-size:14px;font-weight:500}
    .country-dropdown:after{content:"";position:absolute;right:12px;top:50%;transform:translateY(-50%);width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:5px solid var(--sub);pointer-events:none}
    .page{position:fixed;inset:0;background:#fff;z-index:80;opacity:0;transform:translateX(100%);transition:transform .35s var(--ease), opacity .35s var(--ease);pointer-events:none}
    .page.active{opacity:1;transform:translateX(0);pointer-events:auto}
    .page-header{display:flex;align-items:center;gap:12px;padding:16px 24px;border-bottom:1px solid var(--line);background:#fff}
    .page-content{padding:24px;overflow-y:auto;height:calc(100vh - 70px)}
    .help{font-size:12px;color:#6e6e73}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid #e5e5ea;background:#fafafa;font-size:12px}
    /* 聊天相关样式 */
    .chat-panel{position:fixed;right:16px;bottom:16px;z-index:90;width:min(420px,92vw);height:520px;border:1px solid var(--line);border-radius:16px;background:#fff;box-shadow:0 12px 40px rgba(0,0,0,.15);display:none;flex-direction:column}
    .chat-panel.active{display:flex}
    .chat-header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--line)}
    .chat-body{flex:1;overflow:auto;padding:12px}
    .chat-item{margin:8px 0;display:flex;gap:8px}
    .chat-me{justify-content:flex-end}
    .chat-bubble{max-width:75%;padding:10px 12px;border-radius:14px;border:1px solid #e5e5ea;background:#fafafa;font-size:14px;line-height:1.4}
    .chat-me .chat-bubble{background:#111;color:#fff;border-color:#111}
    .chat-meta{font-size:11px;color:#6e6e73;margin-top:2px}
    .chat-input{display:flex;gap:8px;padding:10px;border-top:1px solid var(--line);background:#fff}
    .chat-input input{flex:1;border:1px solid var(--line);border-radius:999px;padding:10px 14px}
    /* 聊天大厅样式 */
    .chat-lobby{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;padding:16px}
    .chat-room-card{display:flex;flex-direction:column;border:1px solid var(--line);border-radius:12px;overflow:hidden;transition:all .2s var(--ease)}
    .chat-room-card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.08)}
    .chat-room-header{padding:12px;background:var(--bg-alt);display:flex;align-items:center;gap:8px}
    .chat-room-body{padding:12px;display:flex;flex-direction:column;gap:8px}
    .chat-room-footer{padding:12px;border-top:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    .chat-room-avatar{width:40px;height:40px;border-radius:50%;background:var(--brand);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:bold}
    .chat-room-title{font-weight:600;flex:1}
    .chat-room-desc{font-size:14px;color:var(--sub);line-height:1.4}
    .chat-room-meta{display:flex;align-items:center;gap:12px;font-size:13px;color:var(--sub)}
    .chat-room-meta i{margin-right:4px}
    .chat-room-badge{background:var(--brand);color:#fff;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:600}
    .chat-tab-bar{display:flex;border-bottom:1px solid var(--line);background:#fff}
    .chat-tab{flex:1;text-align:center;padding:12px;font-weight:600;color:var(--sub);transition:all .2s var(--ease);border-bottom:2px solid transparent}
    .chat-tab.active{color:var(--brand);border-bottom-color:var(--brand)}
    /* 悬浮聊天按钮 */
    .chat-toggle-btn{position:fixed;right:16px;bottom:80px;width:52px;height:52px;border-radius:50%;background:var(--brand);color:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(0,0,0,.15);z-index:80;transition:transform .2s var(--ease)}
    .chat-toggle-btn:hover{transform:scale(1.05)}
    .chat-indicator{position:absolute;top:-4px;right:-4px;width:18px;height:18px;border-radius:50%;background:#ff3b30;color:#fff;font-size:11px;display:flex;align-items:center;justify-content:center}
    .chat-action-btn{display:inline-flex;align-items:center;gap:4px;padding:6px 12px;border-radius:999px;background:var(--bg-alt);font-size:13px;font-weight:500;color:var(--ink);transition:all .2s var(--ease)}
    .chat-action-btn:hover{background:#e5e5ea}
  
    .cmt-images{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .cmt-images img{width:80px;height:80px;object-fit:cover;border-radius:8px;border:1px solid #e5e5ea}
    .cmt-actions{display:flex;gap:10px;margin-top:6px}
    .cmt-actions button{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid #d2d2d7}
    .cmt-badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid #e5e5ea;background:#fafafa;font-size:12px}
    .cmt-reported{opacity:.6;filter:grayscale(30%)}

</style>
</head>
<body>
  <a href="#home" class="sr-only focus:not-sr-only focus:fixed focus:top-2 focus:left-2 bg-[var(--brand)] text-white px-3 py-1 rounded z-[100]">跳到主要内容</a>

  <header class="sticky top-0 z-50 glass border-b border-[#e5e5ea]">
    <div class="container-apple py-3 flex items-center justify-between">
      <a href="#home" class="flex items-center gap-2" aria-label="Unilink 首页">
        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-[var(--brand)] text-white text-sm font-bold">U</span>
        <b>Unilink</b><span id="globalVerifyBadge" class="ml-2 badge" style="display:none"><i class="fa-solid fa-shield"></i><span>已认证</span></span>
      </a>
      <nav class="hidden md:flex items-center gap-6 text-[15px]" aria-label="主导航">
        <a class="hover:opacity-70" href="#trade">交易</a>
        <a class="hover:opacity-70" href="#community">社区</a>
        <a class="hover:opacity-70" href="#reviews">院校评价</a>
        <a class="hover:opacity-70" href="#resources">服务中心</a>
      </nav>
      <div class="flex items-center gap-3">
        <button id="publishBtnTop" class="btn btn-black">发布</button>
        <button id="avatarBtn" class="w-9 h-9 rounded-full border flex items-center justify-center" aria-label="打开个人菜单">
          <i class="fa-regular fa-user"></i>
        </button>
      </div>
    </div>
  </header>

  <main>
    <section id="home" class="hero">
      <div class="container-apple hero-inner">
        <div class="brand-badge fade mx-auto"><span class="dot"></span><span class="text-[13px]">留学中 · 品牌主阵地</span></div>
        <h1 class="h1 mt-6 fade d1">留学生活，从这里连接</h1>
        <p class="sub mt-3 max-w-2xl mx-auto fade d2">交易、社区与院校评价的统一入口。为在校留学生提供跑腿代购、二手交易、经验交流与择校参考。</p>
        <div class="mt-8 flex flex-wrap justify-center gap-4 fade d3">
          <button class="btn btn-black" data-page="taskhall">进入交易</button>
          <button class="btn btn-outline" data-page="community-home">进入社区</button>
          <button class="btn btn-outline" data-page="reviews-all">院校评价</button>
        </div>
      </div>
    </section>

    <section id="trade" class="py-20 bg-[var(--bg)]">
      <div class="container-apple">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-6">
          <div>
            <div class="eyebrow">TRADE</div>
            <h2 class="h2 mt-1">交易 · 任务 / 跑腿 / 二手 / 团购</h2>
            <p class="sub mt-1">面向留学中用户的高频刚需，平台撮合更高效</p>
          </div>
          <div class="flex items-center gap-3">
            <button class="btn btn-outline" id="publishBtnTrade">发布需求</button>
            <button class="chat-action-btn" data-page="trade-chat-lobby">
              <i class="fa-regular fa-comments"></i> 交易聊天
            </button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
          <a class="tile p-6 block cursor-pointer" data-page="taskhall"><h3 class="font-semibold text-lg">任务大厅</h3><p class="sub mt-1">悬赏占座、搬运行李、代购</p></a>
          <a class="tile p-6 block cursor-pointer" data-page="errands"><h3 class="font-semibold text-lg">跑腿代购</h3><p class="sub mt-1">校内 30 分钟达 · 实时位置</p></a>
          <a class="tile p-6 block cursor-pointer" data-page="market"><h3 class="font-semibold text-lg">二手市场</h3><p class="sub mt-1">真图真价 · 当面验货</p></a>
          <a class="tile p-6 block cursor-pointer" data-page="groupbuy"><h3 class="font-semibold text-lg">校园团购</h3><p class="sub mt-1">本地商家拼单优惠</p></a>
        </div>

        <div>
          <div class="flex items-center justify-between mb-3">
            <h3 class="h2">最新发布</h3>
            <button id="refreshPosts" class="text-[14px] text-[#6e6e73] hover:text-black">刷新</button>
          </div>
          <div id="postsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <div class="mt-12">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-lg">来自我的发布</h3>
            <button class="text-[14px] text-[#6e6e73] hover:text-black" id="clearMyPosts">清空</button>
          </div>
          <div id="tradeMyPosts" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
          <div id="tradeMyPostsEmpty" class="text-[#6e6e73]">暂无内容，点击上方"发布需求"试试～</div>
        </div>
      </div>
    </section>

    <section id="community" class="py-20 bg-[var(--bg-alt)]">
      <div class="container-apple">
        <div class="flex items-end justify-between mb-6">
          <div>
            <div class="eyebrow">COMMUNITY</div>
            <h2 class="h2 mt-1">社区 · 热门话题与活动</h2>
            <p class="sub mt-1">真实交流，沉淀高质量经验与口碑</p>
          </div>
          <div class="flex items-center gap-3">
            <button class="btn btn-outline" data-page="community-home">进入社区</button>
            <button class="chat-action-btn" data-page="community-chat-lobby">
              <i class="fa-regular fa-comments"></i> 社区聊天
            </button>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="communityCards"></div>
      </div>
    </section>

    <section id="reviews" class="py-20 bg-[var(--bg)]">
      <div class="container-apple">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-6">
          <div>
            <div class="eyebrow">REVIEWS</div>
            <h2 class="h2 mt-1">院校评价</h2>
            <p class="sub mt-1">按院校/专业/维度查看真实体验，可搜索与排序</p>
          </div>
          <div class="flex items-center gap-3">
            <div class="relative">
              <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-[#6e6e73]"></i>
              <input id="reviewsSearch" class="pl-9 pr-3 py-2 border rounded-full text-[15px]" placeholder="搜索：院校/专业" />
            </div>
            <button class="btn btn-outline" data-page="reviews-all">查看全部院校</button>
          </div>
        </div>
        <div class="tile table-wrap">
          <table class="min-w-full text-[15px]">
            <thead class="bg-[#fafafa] border-b select-none">
              <tr>
                <th scope="col" class="text-left py-3 px-4 cursor-pointer" data-sort="school">院校</th>
<th scope="col" class="text-left py-3 px-4">课程强度</th>
<th scope="col" class="text-left py-3 px-4">生活便利</th>
<th scope="col" class="text-left py-3 px-4">就业资源</th>
<th scope="col" class="text-left py-3 px-4 cursor-pointer" data-sort="score">总体评分</th>
<th scope="col" class="text-left py-3 px-4">详情</th>
              </tr>
            </thead>
            <tbody id="reviewsTbody" aria-live="polite"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="resources" class="py-20 bg-[var(--bg-alt)]">
      <div class="container-apple">
        <h2 class="h2">常用服务</h2>
        <p class="sub mt-1 mb-6">签证/住宿/校务/兼职等入口</p>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-6">
          <a class="tile p-6 text-center cursor-pointer" data-page="svc-campus"><i class="fa-solid fa-id-card text-2xl mb-2"></i><div class="font-semibold">学生证/校车</div><div class="sub">校务与交通</div></a>
          <a class="tile p-6 text-center cursor-pointer" data-page="svc-visa"><i class="fa-solid fa-shield-halved text-2xl mb-2"></i><div class="font-semibold">签证/居留</div><div class="sub">出入境相关</div></a>
          <a class="tile p-6 text-center cursor-pointer" data-page="svc-housing"><i class="fa-solid fa-house-chimney text-2xl mb-2"></i><div class="font-semibold">住宿/租房</div><div class="sub">校内外房源</div></a>
          <a class="tile p-6 text-center cursor-pointer" data-page="svc-jobs"><i class="fa-solid fa-briefcase text-2xl mb-2"></i><div class="font-semibold">兼职/实习</div><div class="sub">岗位与内推</div></a>
          <a class="tile p-6 text-center cursor-pointer" data-page="membership"><i class="fa-solid fa-crown text-2xl mb-2"></i><div class="font-semibold">会员中心</div><div class="sub">VIP 特权与管理</div></a>
        </div>
      </div>
    </section>
  </main>

  <footer class="border-t">
    <div class="container-apple py-10 text-[13px] text-[#6e6e73]">© 2025 Unilink · 留学生活 · 交易与社区</div>
  </footer>

  <nav id="mobileTabs" class="md:hidden fixed bottom-0 inset-x-0 bg-white/90 backdrop-blur border-t z-40" style="padding-bottom:env(safe-area-inset-bottom)">
    <div class="grid grid-cols-5 text-sm text-[#6e6e73]">
      <a href="#home" class="flex flex-col items-center py-2"><i class="fa-solid fa-house"></i><span>首页</span></a>
      <a href="#trade" class="flex flex-col items-center py-2"><i class="fa-solid fa-bag-shopping"></i><span>交易</span></a>
      <a href="#community" class="flex flex-col items-center py-2"><i class="fa-solid fa-people-group"></i><span>社区</span></a>
      <a href="#reviews" class="flex flex-col items-center py-2"><i class="fa-solid fa-graduation-cap"></i><span>院校</span></a>
      <a href="#resources" class="flex flex-col items-center py-2"><i class="fa-solid fa-gear"></i><span>我的</span></a>
    </div>
  </nav>

  <!-- 用户抽屉 -->
  <aside id="userDrawer" class="drawer" role="dialog" aria-modal="true" aria-labelledby="userPanelTitle" style="padding-bottom:env(safe-area-inset-bottom);">
    <header class="px-5 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-[var(--brand)] text-white flex items-center justify-center">U</div>
        <div>
          <div class="font-semibold" id="userPanelTitle">未登录用户</div>
          <div class="text-[12px] text-[#6e6e73]">点击下方登录 / 注册</div>
          <div id="userVipBadge" class="mt-1 hidden text-[12px]"><span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full border"><i class="fa-solid fa-crown"></i><span id="vipText">VIP</span></span></div>
        </div>
      </div>
      <button id="closeDrawerBtn" class="text-[#6e6e73]" aria-label="关闭"><i class="fas fa-times"></i></button>
    </header>
    <div class="p-5 space-y-2 text-[15px]">
      <a href="#trade" class="flex items-center gap-3 p-3 rounded-lg hover:bg-[#f5f5f7]"><i class="fa-solid fa-bag-shopping w-5 text-center"></i>交易</a>
      <a href="#community" class="flex items-center gap-3 p-3 rounded-lg hover:bg-[#f5f5f7]"><i class="fa-solid fa-people-group w-5 text-center"></i>社区</a>
      <a href="#reviews" class="flex items-center gap-3 p-3 rounded-lg hover:bg-[#f5f5f7]"><i class="fa-solid fa-graduation-cap w-5 text-center"></i>院校评价</a>
      <a href="#resources" class="flex items-center gap-3 p-3 rounded-lg hover:bg-[#f5f5f7]"><i class="fa-solid fa-book-open w-5 text-center"></i>服务中心</a>
      <a href="#membership" class="flex items-center gap-3 p-3 rounded-lg hover:bg-[#f5f5f7]"><i class="fa-solid fa-crown w-5 text-center"></i>会员中心</a>
      <div class="h-px bg-[#e5e5ea] my-3"></div>
      <button class="w-full btn btn-outline" id="loginBtn">登录 / 注册</button>
      <button class="w-full btn btn-outline hidden" id="logoutBtn">退出登录</button>
      <div class="h-px bg-[#e5e5ea] my-3"></div>
      <div>
        <div class="font-semibold mb-2">我的发布</div>
        <div id="myPosts" class="space-y-2 text-[14px]"><div class="text-[#6e6e73]" id="myPostsEmpty">暂无发布内容</div></div>
      </div>
    </div>
  
    <div class="tile p-4 border rounded-xl mx-5 mt-4">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <div class="font-semibold">会员中心</div>
          <div id="memberLevelText" style="font-size:13px;color:#6e6e73">Free（普通用户）</div>
        </div>
        <span id="memberBadge" class="vip-badge" style="display:none"><i class="fa-solid fa-crown"></i> VIP</span>
      </div>
      <div id="memberExpire" style="font-size:12px;color:#6e6e73;margin-top:6px">到期时间：—</div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="btnUpgradeVIP" class="btn btn-black" style="flex:1">开通 VIP</button>
        <button id="btnDowngrade" class="btn btn-outline" style="flex:1;display:none">取消 VIP</button>
      </div>
    </div>
  
    <div class="tile p-4 border rounded-xl mx-5 mt-4">
      <div class="font-semibold">认证状态</div>
      <div id="verifyStatusText" class="text-sm text-[#6e6e73] mt-1">未认证</div>
      <div id="verifyExpireText" class="text-sm text-[#6e6e73]">有效期：—</div>
      <div class="flex gap-2 mt-3">
        <button id="btnOpenVerify" class="btn btn-black flex-1">提交认证</button>
        <button id="btnReverify" class="btn btn-outline flex-1" style="display:none">重新认证</button>
      </div>
      <div class="help mt-2">材料二选一：在读证明或录取通知书；填写入学年份和学制（年），系统自动计算账号有效期（毕业年 12 月 31 日）。</div>
    </div>

  </aside>

  <!-- 遮罩与弹层 -->
  <div id="overlay" class="fixed inset-0 bg-black/40 hidden z-[60]"></div>

  <!-- 发布表单 -->
  <div id="publishSheet" class="fixed left-1/2 -translate-x-1/2 bottom-4 w-[92%] max-w-xl bg-white rounded-2xl shadow-2xl border p-6 z-[70] hidden">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-semibold">发布到 Unilink</h3>
      <button id="closePublish" class="text-[#6e6e73]" aria-label="关闭"><i class="fas fa-times"></i></button>
    </div>
    <form id="publishForm" class="grid gap-4">
      <div class="grid md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm text-[#6e6e73] mb-1">类型</label>
          <div class="relative">
            <select name="type" class="w-full rounded-xl border border-[#d2d2d7] bg-white px-4 py-2.5 text-[15px] appearance-none focus:outline-none focus:ring-2 focus:ring-black/10 focus:border-[var(--brand)]">
              <option value="errand">跑腿/代购</option>
              <option value="market">二手转让</option>
              <option value="task">悬赏任务</option>
              <option value="groupbuy">校园团购</option>
            </select>
            <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-[#6e6e73] pointer-events-none"></i>
          </div>
        </div>
        <div>
          <label class="block text-sm text-[#6e6e73] mb-1">预算/价格（<span id="currencyUnit">$</span>）</label>
          <input name="price" id="priceInput" type="number" min="0" step="1" class="w-full rounded-xl border border-[#d2d2d7] bg-white px-4 py-2.5 text-[15px]" required />
        </div>
        <div>
          <label class="block text-sm text-[#6e6e73] mb-1">国家/地区</label>
          <div class="relative">
            <select name="fcountry" id="countrySelect" class="w-full rounded-xl border border-[#d2d2d7] bg-white px-4 py-2.5 text-[15px] appearance-none focus:outline-none focus:ring-2 focus:ring-black/10 focus:border-[var(--brand)]"></select>
            <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-[#6e6e73] pointer-events-none"></i>
          </div>
        </div>
      </div>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm text-[#6e6e73] mb-1">院校（按国家联动）</label>
          <input name="school" id="schoolInput" list="schoolList" class="w-full rounded-xl border border-[#d2d2d7] bg-white px-4 py-2.5 text-[15px]" placeholder="选择或输入院校名" />
          <datalist id="schoolList"></datalist>
          <div class="help mt-1">数据来自标准库，可逐步扩展。</div>
        </div>
        <div>
          <label class="block text-sm text-[#6e6e73] mb-1">校区/城市</label>
          <input name="campus" class="w-full rounded-xl border border-[#d2d2d7] bg-white px-4 py-2.5 text-[15px]" placeholder="如：嘉泉大学" />
        </div>
      </div>
      <div>
        <label class="block text-sm text-[#6e6e73] mb-1">标题</label>
        <input name="title" class="w-full rounded-xl border border-[#d2d2d7] bg-white px-4 py-2.5 text-[15px]" placeholder="例如：求帮忙取快递 / 出闲置 iPad" required />
      </div>
      <div>
        <label class="block text-sm text-[#6e6e73] mb-1">详细说明</label>
        <textarea name="desc" rows="3" class="w-full rounded-xl border border-[#d2d2d7] bg-white px-4 py-2.5 text-[15px]" placeholder="补充时间、地点、规格等信息" required></textarea>
      </div>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm text-[#6e6e73] mb-1">联系方式</label>
          <input name="contact" class="w-full rounded-xl border border-[#d2d2d7] bg-white px-4 py-2.5 text-[15px]" placeholder="微信/手机号" required />
        </div>
        <div class="flex flex-col gap-1">
          <label class="inline-flex items-center gap-2 text-sm mt-6">
            <input type="checkbox" name="urgent" id="urgentChk"/> 紧急（自动同步）
            <span class="badge" title="勾选后将在每天固定时间自动同步到微信社区，提升曝光，适合时间敏感的任务"> <i class="fa-regular fa-circle-question"></i> 说明 </span>
          </label>
          <div class="help">同步频次：每天一次 · 同步时间：<span id="syncTimeLbl">20:00（首尔）</span> · 目标：已绑定的微信社区</div>
        </div>
      </div>
      <div class="flex items-center justify-between">
        <div class="help">发布即代表你同意平台社区规范。</div>
        <button class="btn btn-black" type="submit">发布</button>
      </div>
    </form>
  </div>

  <!-- 详情弹窗 -->
  <div id="postDetail" class="fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[92%] max-w-lg bg-white rounded-2xl shadow-2xl border p-6 z-[80] hidden">
    <div class="flex items-center justify-between mb-3"><h3 id="detailTitle" class="text-lg font-semibold">详情</h3><button id="closeDetail" class="text-[#6e6e73]" aria-label="关闭"><i class="fas fa-times"></i></button></div>
    <div class="space-y-2 text-[15px]">
      <div class="text-[#6e6e73]" id="detailType">—</div>
      <div id="detailDesc">—</div>
      <div class="text-[14px]">价格：<b id="detailPrice">—</b></div>
      <div class="text-[14px]">国家：<span id="detailCountry">—</span></div>
      <div class="text-[14px]">院校：<span id="detailSchool">—</span></div>
      <div class="text-[14px]">校区：<span id="detailCampus">—</span></div>
      <div class="text-[14px]">联系方式：<span id="detailContact">—</span></div>
    </div>
    <div class="mt-4 flex gap-2">
      <button id="copyContact" class="btn btn-outline flex-1">复制联系方式</button>
      <button id="openChatFromDetail" class="btn btn-outline flex-1">
        <i class="fa-regular fa-comments"></i> 发起聊天
      </button>
      <button id="markDone" class="btn btn-black flex-1">标记完成</button>
    </div>
  </div>

  <!-- 登录弹窗 -->
  <div id="authSheet" class="fixed left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2 w-[92%] max-w-md bg-white rounded-2xl shadow-2xl border p-6 z-[90] hidden">
    <div class="flex items-center justify之间 mb-3"><h3 class="text-lg font-semibold">登录 / 注册</h3><button id="closeAuth" class="text-[#6e6e73]" aria-label="关闭"><i class="fas fa-times"></i></button></div>
    <div class="space-y-4">
      <div>
        <div class="text-sm text-[#6e6e73] mb-2">选择用户类型</div>
        <div class="seg" id="segUserType">
          <input type="radio" name="ut" id="ut_student" value="student" checked><label for="ut_student">留学生用户</label>
          <input type="radio" name="ut" id="ut_other" value="other"><label for="ut_other">其他用户</label>
        </div>
      </div>
      <div id="authEmailWrap">
        <label class="block text-sm text-[#6e6e73] mb-1">邮箱（留学生必填）</label>
        <input id="emailInput" type="email" class="w-full rounded-xl border border-[#d2d2d7] bg-white px-4 py-2.5 text-[15px]" placeholder="you@example.com" />
      </div>
      <div id="authWechatWrap">
        <label class="block text-sm text-[#6e6e73] mb-1">微信（所有用户必填）</label>
        <input id="wechatInput" type="text" class="w-full rounded-xl border border-[#d2d2d7] bg-white px-4 py-2.5 text-[15px]" placeholder="微信号" />
      </div>
      <div class="flex gap-2">
        <button id="doLogin" class="btn btn-black flex-1">确认登录</button>
        <button id="doLogout" class="btn btn-outline flex-1 hidden">退出</button>
      </div>
      <div class="text-[13px] text-[#6e6e73]">留学生需填写邮箱 + 微信进行验证；其他用户仅需填写微信。</div>
    </div>
  </div>


  <!-- 认证弹窗 -->
  <div id="verifySheet" class="fixed left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2 w-[92%] max-w-xl bg-white rounded-2xl shadow-2xl border p-6 z-[95] hidden">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-semibold">留学生认证</h3>
      <button id="closeVerify" class="text-[#6e6e73]" aria-label="关闭"><i class="fas fa-times"></i></button>
    </div>
    <form id="verifyForm" class="grid gap-4">
      <div>
        <label class="block text-sm text-[#6e6e73] mb-1">材料类型</label>
        <div class="grid grid-cols-2 gap-2">
          <label class="border rounded-lg p-3 cursor-pointer flex items-center gap-2">
            <input type="radio" name="docType" value="enroll" checked />
            <span>在读证明</span>
          </label>
          <label class="border rounded-lg p-3 cursor-pointer flex items-center gap-2">
            <input type="radio" name="docType" value="offer" />
            <span>录取通知书</span>
          </label>
        </div>
      </div>
      <div>
        <label class="block text-sm text-[#6e6e73] mb-1">上传文件（JPG/PNG/PDF，≤5MB）</label>
        <input id="verifyFile" type="file" accept=".jpg,.jpeg,.png,.pdf" class="w-full" required />
      </div>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm text-[#6e6e73] mb-1">入学年份</label>
          <select id="enrollYear" class="w-full rounded-xl border border-[#d2d2d7] bg-white px-4 py-2.5 text-[15px]"></select>
        </div>
        <div>
          <label class="block text-sm text-[#6e6e73] mb-1">学制（年）</label>
          <select id="programYears" class="w-full rounded-xl border border-[#d2d2d7] bg-white px-4 py-2.5 text-[15px]">
            <option>1</option><option>2</option><option>3</option><option selected>4</option><option>5</option><option>6</option><option>7</option><option>8</option>
          </select>
        </div>
      </div>
      <div class="help">账号有效期将自动计算为 <span id="calcExpire">—</span>（毕业年度 12 月 31 日）。</div>
      <div class="flex items-center justify-between">
        <div class="help">提交后进入人工审核（当前前端先生效，接后台后改为待审核）。</div>
        <button class="btn btn-black" type="submit">提交认证</button>
      </div>
    </form>
  </div>



  <!-- 院校详情页（动态渲染） -->
  <section id="page-school-detail" class="page" role="dialog" aria-modal="true" aria-labelledby="schoolDetailTitle">
    <div class="page-header">
      <button class="btn btn-outline" data-back><i class="fas fa-arrow-left"></i></button>
      <h3 class="h2" id="schoolDetailTitle">院校详情</h3>
    </div>
    <div class="page-content">
      <div id="schoolSummary" class="tile p-4 mb-4"></div>
      <div class="grid md:grid-cols-2 gap-4">
        <div class="tile p-4">
          <div class="font-semibold mb-2">专业列表</div>
          <div id="schoolMajors"></div>
        </div>
        <div class="tile p-4">
          <div class="flex items-center justify-between mb-2">
            <div class="font-semibold">学生评分与评论</div>
            <div id="schoolAvgScore" class="text-sm text-[#6e6e73]"></div>
          </div>
          <div id="schoolReviewsList" class="space-y-3"></div>
          <div id="schoolReviewFormWrap" class="mt-4"></div>
<div id="reportModal" class="fixed inset-0 bg-black/40 hidden z-[120]"><div class="absolute left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl border p-6 w-[92%] max-w-md"><div class="font-semibold mb-2">举报评论</div><div class="text-sm text-[#6e6e73] mb-3">请选择或填写举报原因</div><select id="reportReason" class="w-full border rounded px-3 py-2 mb-2"><option value="广告/推广">广告/推广</option><option value="不友善/攻击">不友善/攻击</option><option value="不实信息">不实信息</option><option value="低质/灌水">低质/灌水</option><option value="其他">其他</option></select><textarea id="reportExtra" rows="2" class="w-full border rounded px-3 py-2" placeholder="补充说明（可选）"></textarea><div class="flex gap-2 mt-3"><button id="reportSubmit" class="btn btn-black flex-1">提交举报</button><button id="reportCancel" class="btn btn-outline flex-1">取消</button></div></div></div>
        </div>
      </div>
    </div>
  </section>


  <!-- 路由页面 -->
  <div id="pageRouter">
    <section id="page-taskhall" class="page">
      <div class="page-header">
        <button class="btn btn-outline" data-back><i class="fas fa-arrow-left"></i></button>
        <h3 class="h2">任务大厅</h3>
      </div>
      <div class="page-content">
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-3">
            <div class="relative">
              <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-[#6e6e73]"></i>
              <input id="taskSearch" class="pl-9 pr-3 py-2 border rounded-full text-[15px]" placeholder="搜索任务..." />
            </div>
            <div class="country-dropdown"><select id="taskCountryFilter"></select></div>
          </div>
          <button class="btn btn-black" id="publishTaskBtn">发布任务</button>
        </div>
        <div id="taskList"></div>
      </div>
    </section>

    <section id="page-errands" class="page">
      <div class="container-apple py-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="h2">跑腿代购</h3>
          <button class="btn btn-outline" data-back>返回</button>
        </div>
        <div id="errandsList" class="grid gap-4"></div>
      </div>
    </section>

    <section id="page-market" class="page">
      <div class="container-apple py-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="h2">二手市场</h3>
          <button class="btn btn-outline" data-back>返回</button>
        </div>
        <div id="marketList" class="grid gap-4"></div>
      </div>
    </section>

    <section id="page-groupbuy" class="page">
      <div class="container-apple py-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="h2">校园团购</h3>
          <button class="btn btn-outline" data-back>返回</button>
        </div>
        <div id="groupbuyList" class="grid gap-4"></div>
      </div>
    </section>

    <section id="page-community-home" class="page">
      <div class="container-apple py-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="h2">社区首页</h3>
          <button class="btn btn-outline" data-back>返回</button>
        </div>
        <div class="grid md:grid-cols-2 gap-4">
          <div class="tile p-4">
            <div class="font-semibold mb-2">最新话题</div>
            <div id="topicList"></div>
          </div>
          <div class="tile p-4">
            <div class="font-semibold mb-2">发帖（本地）</div>
            <form id="topicForm" class="grid gap-2">
              <input id="topicTitle" class="border rounded px-3 py-2" placeholder="标题（如：期末高效复习法）" required/>
              <textarea id="topicBody" rows="3" class="border rounded px-3 py-2" placeholder="内容..." required></textarea>
              <button class="btn btn-black" type="submit">发布话题</button>
            </form>
          </div>
        </div>
      </div>
    </section>

    <section id="page-topic-exam" class="page">
      <div class="container-apple py-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="h2">话题：期末高效复习法</h3>
          <button class="btn btn-outline" data-back>返回</button>
        </div>
        <div id="topic-exam-body" class="prose"></div>
      </div>
    </section>

    <section id="page-topic-job" class="page">
      <div class="container-apple py-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="h2">话题：校内兼职怎么找？</h3>
          <button class="btn btn-outline" data-back>返回</button>
        </div>
        <div id="topic-job-body" class="prose"></div>
      </div>
    </section>

    <section id="page-topic-rent" class="page">
      <div class="container-apple py-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="h2">话题：2025 租房避坑指南</h3>
          <button class="btn btn-outline" data-back>返回</button>
        </div>
        <div id="topic-rent-body" class="prose"></div>
      </div>
    </section>

    <section id="page-reviews-all" class="page">
      <div class="container-apple py-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="h2">全部院校</h3>
          <button class="btn btn-outline" data-back>返回</button>
        </div>
        <div id="reviewsAll" class="grid md:grid-cols-2 gap-4"></div>
      </div>
    </section>

    <section id="page-svc-campus" class="page">
      <div class="container-apple py-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="h2">学生证/校车</h3>
          <button class="btn btn-outline" data-back>返回</button>
        </div>
        <div class="tile p-4">
          <div class="font-semibold mb-2">常用入口</div>
          <ul class="list-disc pl-6 text-[15px] space-y-2">
            <li><a class="text-blue-600 underline" href="https://www.gachon.ac.kr/" target="_blank" rel="noopener">嘉泉大学校务系统</a></li>
            <li><a class="text-blue-600 underline" href="https://www.seoulbus.co.kr/" target="_blank" rel="noopener">首尔巴士实时查询</a></li>
          </ul>
        </div>
      </div>
    </section>

    <section id="page-svc-visa" class="page">
      <div class="container-apple py-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="h2">签证/居留</h3>
          <button class="btn btn-outline" data-back>返回</button>
        </div>
        <div class="tile p-4">
          <div class="font-semibold mb-2">官方链接</div>
          <ul class="list-disc pl-6 text-[15px] space-y-2">
            <li><a class="text-blue-600 underline" href="https://www.hikorea.go.kr/" target="_blank" rel="noopener">HiKorea 出入境</a></li>
          </ul>
        </div>
      </div>
    </section>

    <section id="page-svc-housing" class="page">
      <div class="container-apple py-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="h2">住宿/租房</h3>
          <button class="btn btn-outline" data-back>返回</button>
        </div>
        <div id="housingList" class="grid gap-4"></div>
      </div>
    </section>

    <section id="page-svc-jobs" class="page">
      <div class="container-apple py-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="h2">兼职/实习</h3>
          <button class="btn btn-outline" data-back>返回</button>
        </div>
        <div id="jobsList" class="grid gap-4"></div>
      </div>
    </section>

    <section id="page-membership" class="page">
      <div class="container-apple py-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="h2">会员中心</h3>
          <button class="btn btn-outline" data-back>返回</button>
        </div>
        <div class="tile p-4">
          <div class="font-semibold">权益</div>
          <ul class="list-disc pl-6 text-[15px] space-y-1">
            <li>发布置顶优先展示</li>
            <li>紧急任务优先同步到微信社区</li>
            <li>专属客服与活动优先报名</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- 聊天大厅页面 -->
    <section id="page-trade-chat-lobby" class="page">
      <div class="page-header">
        <button class="btn btn-outline" data-back><i class="fas fa-arrow-left"></i></button>
        <h3 class="h2">交易聊天大厅</h3>
      </div>
      <div class="page-content">
        <div class="chat-tab-bar">
          <div class="chat-tab active" data-tab="trade-active">活跃聊天</div>
          <div class="chat-tab" data-tab="trade-recent">最近聊天</div>
          <div class="chat-tab" data-tab="trade-groups">群组</div>
        </div>
        <div class="chat-lobby" id="tradeLobby"></div>
      </div>
    </section>
    
    <section id="page-community-chat-lobby" class="page">
      <div class="page-header">
        <button class="btn btn-outline" data-back><i class="fas fa-arrow-left"></i></button>
        <h3 class="h2">社区聊天大厅</h3>
      </div>
      <div class="page-content">
        <div class="chat-tab-bar">
          <div class="chat-tab active" data-tab="community-active">热门话题</div>
          <div class="chat-tab" data-tab="community-study">学习交流</div>
          <div class="chat-tab" data-tab="community-life">生活互助</div>
        </div>
        <div class="chat-lobby" id="communityLobby"></div>
      </div>
    </section>
  </div>

  <button id="fab" class="fixed bottom-6 right-6 w-14 h-14 rounded-full bg-[var(--brand)] text-white text-xl shadow-xl flex items-center justify-center" aria-label="发布"><i class="fas fa-plus"></i></button>

  <!-- 聊天面板 -->
  <div id="chatPanel" class="chat-panel" role="dialog" aria-modal="true" aria-labelledby="chatRoomTitle">
    <div class="chat-header">
      <div class="flex items-center gap-2"><i class="fa-regular fa-comments"></i><b id="chatRoomTitle">聊天</b></div>
      <div class="flex items-center gap-2"><span id="chatRoomBadge" class="text-xs" style="opacity:.7"></span>
        <button id="closeChatBtn" class="btn btn-outline" style="padding:6px 10px"><i class="fas fa-times"></i></button>
      </div>
    </div>
    <div id="chatMessages" class="chat-body" aria-live="polite"></div>
    <div class="chat-input">
      <input id="chatInput" type="text" placeholder="输入消息，回车发送…" />
      <button id="chatSendBtn" class="btn btn-black">发送</button>
    </div>
  </div>
  
  <button id="chatToggleBtn" class="chat-toggle-btn">
    <i class="fa-regular fa-comments"></i>
    <span id="chatNotification" class="chat-indicator" style="display:none">3</span>
  </button>

  <script>
    // ====== CONFIG ======
    const $$ = s => Array.from(document.querySelectorAll(s));
    const $  = s => document.querySelector(s);

    // Supabase 初始化
    const SUPABASE_URL = 'https://your-project.supabase.co'; // 替换为你的 Supabase URL
    const SUPABASE_ANON_KEY = 'your-anon-key'; // 替换为你的 Supabase anon key
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // 线上标识
    const PRODUCTION = true;
    let SYNC_TIME_LABEL = '本地约19:00–21:00';

    // ===== 国家/院校/货币 =====
    // ===== 区域同步时间推荐（不打扰版） =====
    function suggestSyncTimeByZone(tz){
      // Map rough regions to a friendly local time
      // default window 19:00–21:00
      const win = '本地约19:00–21:00';
      if(!tz) return win;
      tz = (tz||'').toLowerCase();
      if(tz.includes('seoul') || tz.includes('tokyo')) return '20:00（本地）';
      if(tz.includes('shanghai') || tz.includes('hong_kong') || tz.includes('taipei')) return '21:00（本地）';
      if(tz.includes('singapore') || tz.includes('kuala_lumpur') || tz.includes('bangkok') || tz.includes('jakarta')) return '20:00（本地）';
      if(tz.includes('london') || tz.includes('berlin') || tz.includes('paris') || tz.includes('madrid') || tz.includes('rome') || tz.includes('amsterdam')) return '19:00（本地）';
      if(tz.includes('new_york') || tz.includes('chicago') || tz.includes('toronto') || tz.includes('vancouver') || tz.includes('los_angeles') || tz.includes('denver')) return '20:00（本地）';
      if(tz.includes('sydney') || tz.includes('melbourne') || tz.includes('auckland')) return '19:30（本地）';
      return win;
    }
    function regionFromCountry(country){
      if(!country) return null;
      const asiaKRJP = ['韩国','日本'];
      const chinaZH = ['中国大陆','中国香港','中国澳门','中国台湾'];
      const sea = ['新加坡','马来西亚','泰国','越南','印度尼西亚','菲律宾','柬埔寨','老挝','缅甸','文莱'];
      const eu = ['英国','法国','德国','荷兰','意大利','西班牙','瑞士','瑞典','丹麦','挪威','芬兰','比利时','奥地利','葡萄牙','爱尔兰'];
      const na = ['美国','加拿大'];
      const oc = ['澳大利亚','新西兰'];
      if(asiaKRJP.includes(country)) return '20:00（本地）';
      if(chinaZH.includes(country)) return '21:00（本地）';
      if(sea.includes(country)) return '20:00（本地）';
      if(eu.includes(country)) return '19:00（本地）';
      if(na.includes(country)) return '20:00（本地）';
      if(oc.includes(country)) return '19:30（本地）';
      return '本地约19:00–21:00';
    }
    function refreshSyncLabel(){
      // priority: selected country in the publish form -> browser timezone
      const countrySel = document.getElementById('countrySelect');
      let label = null;
      if(countrySel && countrySel.value){
        label = regionFromCountry(countrySel.value);
      } else {
        try{
          const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
          label = suggestSyncTimeByZone(tz);
        }catch{ label = '本地约19:00–21:00'; }
      }
      SYNC_TIME_LABEL = label || '本地约19:00–21:00';
      const el = document.getElementById('syncTimeLbl');
      if(el) el.textContent = SYNC_TIME_LABEL;
    }

    const COUNTRIES = ['韩国','美国','英国','日本','澳大利亚','加拿大','德国','法国','荷兰','意大利','西班牙','瑞士','瑞典','新加坡','马来西亚','泰国','俄罗斯','新西兰','爱尔兰','丹麦','挪威','芬兰','比利时','奥地利','葡萄牙','中国香港','中国澳门','中国台湾'];
    const SCHOOLS_BY_COUNTRY = {
      '韩国':['嘉泉大学','延世大学','高丽大学','首尔大学','汉阳大学','成均馆大学','梨花女子大学','庆熙大学','又石大学','西江大学','中央大学','弘益大学'],
      '美国':['Harvard University','MIT','Stanford University','UC Berkeley','UCLA','Columbia University','NYU','Carnegie Mellon University','University of Chicago']
    };
    const currencyByCountry = {
      '韩国': '₩','美国': '$','英国': '£','日本': '¥','澳大利亚': 'A$','加拿大': 'C$','德国': '€','法国': '€','荷兰': '€','意大利': '€','西班牙': '€','瑞士': 'CHF','瑞典': 'kr','新加坡': 'S$','马来西亚': 'RM','泰国': '฿','俄罗斯': '₽','新西兰': 'NZ$','爱尔兰': '€','丹麦': 'kr','挪威': 'kr','芬兰': '€','比利时': '€','奥地利': '€','葡萄牙': '€','中国香港': 'HK$','中国澳门': 'MOP$','中国台湾': 'NT$'
    };

    // ====== 用户与会员 ======
    let currentUser = null;

    // 监听认证状态变化
    supabase.auth.onAuthStateChange(async (event, session) => {
      if (event === 'SIGNED_IN' && session) {
        await handleUserLogin(session.user);
      } else if (event === 'SIGNED_OUT') {
        handleUserLogout();
      }
    });

    // 检查当前会话
    async function checkSession() {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        await handleUserLogin(session.user);
      }
    }

    // 处理用户登录
    async function handleUserLogin(user) {
      currentUser = user;
      
      // 检查用户资料是否存在，不存在则创建
      const { data: profile } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', user.id)
        .single();
      
      if (!profile) {
        // 创建新用户资料
        const { error } = await supabase
          .from('profiles')
          .insert([
            {
              id: user.id,
              email: user.email,
              type: 'other', // 默认类型，可在认证后更新
              created_at: new Date().toISOString(),
              updated_at: new Date().toISOString()
            }
          ]);
        
        if (error) {
          console.error('Error creating profile:', error);
          return;
        }
      }
      
      renderUser();
    }

    // 处理用户登出
    function handleUserLogout() {
      currentUser = null;
      renderUser();
    }

    // 计算认证有效期
    function computeExpire(year, years){
      const y = Number(year) + Number(years);
      return new Date(Date.UTC(y, 11, 31, 15, 59, 59)).toISOString(); // 毕业年 12/31，按KST折算UTC
    }
    
    function yearsOptions(){
      const now = new Date(); const thisYear = now.getFullYear();
      const from = thisYear - 10, to = thisYear + 2;
      const el = document.getElementById('enrollYear'); if(!el) return;
      el.innerHTML = Array.from({length: to-from+1}, (_,i)=>from+i).map(y=>`<option ${y===thisYear?'selected':''}>${y}</option>`).join('');
    }

    // 渲染用户信息
    async function renderUser(){
      const title=$('#userPanelTitle'), loginBtn=$('#loginBtn'), logoutBtn=$('#logoutBtn'), doLogoutBtn=$('#doLogout');
      const vipBadge=$('#userVipBadge'), vipText=$('#vipText');
      const vText=$('#verifyStatusText'), vExpire=$('#verifyExpireText'), reBtn=$('#btnReverify'), gBadge=$('#globalVerifyBadge');
      
      if(currentUser){
        // 获取用户资料
        const { data: profile, error } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', currentUser.id)
          .single();
        
        if (error) {
          console.error('Error fetching profile:', error);
          return;
        }
        
        const isVip = profile.membership_level === 'vip' && 
                     (!profile.membership_expires_at || new Date(profile.membership_expires_at) > new Date());
        
        title.textContent = `${profile.wechat || profile.email || currentUser.email}（${profile.type === 'student' ? '留学生用户' : '其他用户'}）`;
        loginBtn?.classList.add('hidden'); 
        logoutBtn?.classList.remove('hidden'); 
        doLogoutBtn?.classList?.remove('hidden');
        
        if(isVip){ 
          vipBadge?.classList.remove('hidden'); 
          vipText.textContent = 'VIP ' + (profile.membership_expires_at ? ('· 有效期至 '+ new Date(profile.membership_expires_at).toLocaleDateString()) : ''); 
        } else { 
          vipBadge?.classList.add('hidden'); 
        }

        // 验证状态
        const isVerified = profile.verification_level === 'strong' && 
                          (!profile.verification_expires_at || new Date(profile.verification_expires_at) > new Date());
        
        if(gBadge) gBadge.style.display = isVerified ? 'inline-flex' : 'none';
        
        if(vText && vExpire){
          if(profile.verification_level){
            const expired = profile.verification_expires_at && new Date(profile.verification_expires_at) < new Date();
            vText.textContent = isVerified ? '已认证（强）' : (expired ? '已过期' : '审核中');
            vExpire.textContent = '有效期：' + (profile.verification_expires_at ? new Date(profile.verification_expires_at).toLocaleDateString() : '—') + 
                                 (profile.enroll_year ? `（${profile.enroll_year} 入学 / ${profile.program_years}年制）` : '');
            if(reBtn) reBtn.style.display = 'inline-flex';
          } else {
            vText.textContent = '未认证';
            vExpire.textContent = '有效期：—';
            if(reBtn) reBtn.style.display = 'none';
          }
        }
        
        renderMembership(profile);
        renderMyPosts();
      } else {
        title.textContent='未登录用户';
        loginBtn?.classList.remove('hidden'); 
        logoutBtn?.classList.add('hidden'); 
        doLogoutBtn?.classList?.add('hidden');
        vipBadge?.classList.add('hidden');
        if(gBadge) gBadge.style.display='none';
        if(vText){ vText.textContent='未认证'; if(vExpire) vExpire.textContent='有效期：—'; if(reBtn) reBtn.style.display='none'; }
      }
    }

    // 渲染会员信息
    function renderMembership(profile){
      $('#memberLevelText').textContent = (profile.membership_level === 'vip' ? 'VIP（会员）' : 'Free（普通用户）');
      $('#memberBadge').style.display = (profile.membership_level === 'vip' ? 'inline-flex' : 'none');
      $('#memberExpire').textContent = '到期时间：' + (profile.membership_expires_at ? new Date(profile.membership_expires_at).toLocaleString() : '—');
      $('#btnUpgradeVIP').style.display = (profile.membership_level === 'vip' ? 'none' : 'inline-flex');
      $('#btnDowngrade').style.display  = (profile.membership_level === 'vip' ? 'inline-flex' : 'none');
    }

    // 升级VIP
    async function upgradeVip(){
      if(!currentUser){ alert('请先登录'); return; }
      
      const expires = new Date(); 
      expires.setMonth(expires.getMonth() + 1);
      
      const { error } = await supabase
        .from('profiles')
        .update({
          membership_level: 'vip',
          membership_expires_at: expires.toISOString(),
          updated_at: new Date().toISOString()
        })
        .eq('id', currentUser.id);
      
      if (error) {
        console.error('Error upgrading VIP:', error);
        alert('VIP 开通失败');
        return;
      }
      
      renderUser(); 
      alert('VIP 开通成功！');
    }

    // 降级VIP
    async function downgradeVip(){
      if(!currentUser){ return; }
      
      const { error } = await supabase
        .from('profiles')
        .update({
          membership_level: 'free',
          membership_expires_at: null,
          updated_at: new Date().toISOString()
        })
        .eq('id', currentUser.id);
      
      if (error) {
        console.error('Error downgrading VIP:', error);
        alert('取消 VIP 失败');
        return;
      }
      
      renderUser(); 
      alert('已取消 VIP');
    }

    // 打开认证弹窗
    function openAuth(){ 
      $('#overlay').classList.remove('hidden'); 
      $('#authSheet').classList.remove('hidden'); 
      syncAuthFields(); 
    }
    
    // 关闭认证弹窗
    function closeAuth(){ 
      $('#authSheet').classList.add('hidden'); 
      $('#overlay').classList.add('hidden'); 
    }
    
    // 同步认证字段显示
    function syncAuthFields(){ 
      $('#authEmailWrap').classList.toggle('hidden', !$('#ut_student').checked); 
    }
    
    $$('#segUserType input').forEach(r=> r.addEventListener('change', syncAuthFields));

    // 用户登录/注册
    async function signIn(){
      const isStudent = $('#ut_student').checked;
      const email  = ($('#emailInput')?.value||'').trim();
      const wechat = ($('#wechatInput')?.value||'').trim();
      
      if(!wechat){ alert('请填写微信号'); return; }
      if(isStudent && !email){ alert('留学生需填写邮箱'); return; }
      
      try {
        if (isStudent) {
          // 留学生使用邮箱登录
          const { data, error } = await supabase.auth.signInWithOtp({
            email: email,
            options: {
              data: {
                wechat: wechat,
                user_type: 'student'
              }
            }
          });
          
          if (error) throw error;
          alert('验证邮件已发送，请检查您的邮箱');
        } else {
          // 其他用户使用魔术链接登录
          const { data, error } = await supabase.auth.signInWithOtp({
            email: wechat + '@unilink.app', // 使用虚拟邮箱
            options: {
              data: {
                wechat: wechat,
                user_type: 'other'
              }
            }
          });
          
          if (error) throw error;
          alert('登录链接已发送');
        }
        
        closeAuth();
      } catch (error) {
        console.error('Error signing in:', error);
        alert('登录失败: ' + error.message);
      }
    }

    // 用户登出
    async function signOut(){ 
      const { error } = await supabase.auth.signOut();
      if (error) {
        console.error('Error signing out:', error);
        alert('退出登录失败');
        return;
      }
      
      alert('已退出登录'); 
    }

    // 绑定用户面板事件
    $('#avatarBtn')?.addEventListener('click',()=>{ $('#overlay').classList.remove('hidden'); $('#userDrawer').classList.add('active'); });
    $('#closeDrawerBtn')?.addEventListener('click',()=>{ $('#overlay').classList.add('hidden'); $('#userDrawer').classList.remove('active'); });
    $('#loginBtn')?.addEventListener('click', openAuth);
    $('#closeAuth')?.addEventListener('click', closeAuth);
    $('#doLogin')?.addEventListener('click', signIn);
    $('#logoutBtn')?.addEventListener('click', signOut);
    $('#doLogout')?.addEventListener('click', signOut);
    $('#btnUpgradeVIP')?.addEventListener('click', upgradeVip);
    $('#btnDowngrade')?.addEventListener('click', downgradeVip);

    // 点击遮罩关闭
    $('#overlay')?.addEventListener('click',()=>{
      if($('#userDrawer').classList.contains('active')) { $('#overlay').classList.add('hidden'); $('#userDrawer').classList.remove('active'); return; }
      if(!$('#verifySheet').classList.contains('hidden')){ $('#verifySheet').classList.add('hidden'); $('#overlay').classList.add('hidden'); return; }
      if(!$('#postDetail').classList.contains('hidden')){ closePostDetail(); $('#overlay').classList.add('hidden'); return; }
      closePublish();
    });

    // ===== 国家/院校/货币 联动 =====
    function fillCountrySelect(el){ if(!el) return; el.innerHTML = '<option value="">全部国家/地区</option>' + COUNTRIES.map(c=>`<option value="${c}">${c}</option>`).join(''); }
    fillCountrySelect($('#taskCountryFilter'));
    $('#countrySelect').innerHTML = COUNTRIES.map(c=>`<option value="${c}">${c}</option>`).join('');
    function refreshSchoolList(country){ const dl=$('#schoolList'); const arr=SCHOOLS_BY_COUNTRY[country]||[]; dl.innerHTML=arr.map(n=>`<option value="${n}"></option>`).join(''); }
    function syncCurrency(){ const country=$('#countrySelect').value; $('#currencyUnit').textContent = currencyByCountry[country] || '$'; refreshSchoolList(country); refreshSyncLabel(); }
    $('#countrySelect')?.addEventListener('change', syncCurrency); syncCurrency();

    // ===== 图片懒加载 =====
    document.querySelectorAll('img').forEach(img=>{img.loading=img.loading||'lazy'; img.decoding=img.decoding||'async'});

    // ===== Mobile tab 高亮 =====
    function setActiveTab(){const hash=location.hash||'#home'; $$('#mobileTabs a').forEach(a=>{const on=(a.getAttribute('href')===hash)||a.hasAttribute('data-page')&&(`#page-${a.getAttribute('data-page')}`===hash); a.classList.toggle('text-black',on); a.classList.toggle('font-semibold',on);});}
    window.addEventListener('hashchange',setActiveTab); setActiveTab();

    // ===== 弹层开关（发布） =====
    const overlay=$('#overlay');
    const sheet=$('#publishSheet');
    const openPublish=()=>{ 
      if(currentUser) {
        // 检查用户认证状态
        supabase
          .from('profiles')
          .select('verification_level, verification_expires_at')
          .eq('id', currentUser.id)
          .single()
          .then(({ data: profile, error }) => {
            if (error) {
              console.error('Error fetching profile:', error);
              return;
            }
            
            const isVerified = profile.verification_level === 'strong' && 
                              (!profile.verification_expires_at || new Date(profile.verification_expires_at) > new Date());
            
            if(profile.verification_level === 'student' && !isVerified){ 
              openVerify(); 
              alert('请先完成留学生认证，再发布。'); 
              return; 
            } 
            
            document.body.style.overflow='hidden';
            document.getElementById('reportSubmit')?.addEventListener('click', doReport);
            document.getElementById('reportCancel')?.addEventListener('click', closeReport);
            overlay.classList.remove('hidden');
            sheet.classList.remove('hidden');
          });
      } else {
        openAuth();
        alert('请先登录再发布');
      }
    }
    
    const closePublish=()=>{sheet.classList.add('hidden');overlay.classList.add('hidden');document.body.style.overflow='';}
    $('#fab')?.addEventListener('click',openPublish);
    $('#publishBtnTop')?.addEventListener('click',openPublish);
    $('#publishBtnTrade')?.addEventListener('click',openPublish);
    $('#closePublish')?.addEventListener('click',closePublish);
    $('#publishTaskBtn')?.addEventListener('click',openPublish);
    refreshSyncLabel();

    // ===== 帖子数据 =====
    async function loadPosts(){ 
      const { data, error } = await supabase
        .from('posts')
        .select('*')
        .order('created_at', { ascending: false });
      
      if (error) {
        console.error('Error loading posts:', error);
        return [];
      }
      
      return data;
    }
    
    function postTypeName(t){ return t==='errand'?'跑腿/代购': t==='market'?'二手转让': t==='groupbuy'?'校园团购':'悬赏任务'; }
    function currencyFor(country){ return currencyByCountry[country] || '$'; }

    function cardHtml(p){
      return `<div class="tile p-4">
        <div class="flex items-center justify-between">
          <div class="font-semibold">${p.title||'(无标题)'} ${p.urgent?'<span class="ml-1 text-xs text-red-600">紧急</span>':''}</div>
          <span class="text-[13px] text-[#6e6e73]">${postTypeName(p.type)}</span>
        </div>
        <div class="text-[14px] mt-2 line-clamp-2">${p.description||''}</div>
        <div class="text-[13px] mt-2">${currencyFor(p.country)}${p.price||0} · ${p.country}${p.school?(' · '+p.school):''}${p.campus?(' · '+p.campus):''}</div>
        <div class="mt-3 flex gap-2">
          <button class="btn btn-outline flex-1" data-open-detail="${p.id}">查看</button>
          <button class="btn btn-black flex-1" data-open-chat="${p.id}" data-title="${p.title||'聊天'}"><i class="fa-regular fa-comments"></i>&nbsp;聊天</button>
        </div>
      </div>`;
    }

    async function renderPostsList(){
      const list = await loadPosts();
      const filteredList = list.filter(p => p.status !== 'done').slice(0, 9);
      
      $('#postsList').innerHTML = filteredList.map(cardHtml).join('') || '<div class="text-[#6e6e73]">暂无发布，点击右下角 "+" 发布。</div>';
      bindPostButtons();
    }

    async function renderTradePosts(){
      const list = await loadPosts();
      const filteredList = list.filter(p => p.status !== 'done');
      
      const task = filteredList.filter(p => p.type === 'task');
      const errands = filteredList.filter(p => p.type === 'errand');
      const market = filteredList.filter(p => p.type === 'market');
      const groupbuy = filteredList.filter(p => p.type === 'groupbuy');
      
      $('#taskList').innerHTML     = task.map(cardHtml).join('') || '<div class="text-[#6e6e73]">暂无任务</div>';
      $('#errandsList').innerHTML  = errands.map(cardHtml).join('') || '<div class="text-[#6e6e73]">暂无跑腿/代购</div>';
      $('#marketList').innerHTML   = market.map(cardHtml).join('') || '<div class="text-[#6e6e73]">暂无二手</div>';
      $('#groupbuyList').innerHTML = groupbuy.map(cardHtml).join('') || '<div class="text-[#6e6e73]">暂无团购</div>';
      
      bindPostButtons();
    }

    async function renderMyPosts(){
      const wrap = $('#myPosts');
      const empty = $('#myPostsEmpty');
      
      if (!currentUser) {
        empty?.classList.remove('hidden');
        wrap.innerHTML = '';
        return;
      }
      
      const { data: posts, error } = await supabase
        .from('posts')
        .select('*')
        .eq('owner_id', currentUser.id)
        .order('created_at', { ascending: false });
      
      if (error) {
        console.error('Error loading my posts:', error);
        return;
      }
      
      if (!posts || posts.length === 0) {
        empty?.classList.remove('hidden');
        wrap.innerHTML = '';
        return;
      }
      
      empty?.classList.add('hidden');
      wrap.innerHTML = posts.map(p => `
        <div class="post-item border rounded-lg p-3">
          <div class="flex items-start justify-between gap-2">
            <div>
              <div class="font-semibold">${p.title||'(无标题)'} <span class="text-xs text-[#6e6e73]">${postTypeName(p.type)}</span>${p.urgent?' <span class="ml-1 text-xs text-red-600">紧急</span>':''}</div>
              <div class="text-[#6e6e73] text-[13px] mt-1 line-clamp-2">${p.description||''}</div>
              <div class="text-[13px] mt-1">${currencyFor(p.country)}${p.price||0} · ${p.country}${p.school?(' · '+p.school):''} · ${p.campus||''}</div>
              ${p.urgent?'<div class="help mt-1">⏱ 已标记紧急，将于 '+SYNC_TIME_LABEL+' 自动同步到微信社区</div>':''}
            </div>
            <button class="text-[#6e6e73] hover:text-red-600" aria-label="删除" data-del-post="${p.id}"><i class="fa-regular fa-trash-can"></i></button>
          </div>
        </div>
      `).join('');
      
      $$('#myPosts [data-del-post]').forEach(btn => {
        btn.addEventListener('click', async e => {
          const id = e.currentTarget.dataset.delPost;
          
          const { error } = await supabase
            .from('posts')
            .delete()
            .eq('id', id)
            .eq('owner_id', currentUser.id);
          
          if (error) {
            console.error('Error deleting post:', error);
            alert('删除失败');
            return;
          }
          
          renderMyPosts();
          renderPostsList();
          renderTradePosts();
        });
      });
    }
    
    $('#clearMyPosts')?.addEventListener('click', async () => {
      if (!currentUser) return;
      
      const { error } = await supabase
        .from('posts')
        .delete()
        .eq('owner_id', currentUser.id);
      
      if (error) {
        console.error('Error clearing posts:', error);
        alert('清空失败');
        return;
      }
      
      renderMyPosts();
      renderPostsList();
      renderTradePosts();
    });

    // 发布行为
    $('#publishForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if(!currentUser){ 
        alert('请先登录再发布'); 
        return; 
      }
      
      const f = e.target;
      const data = {
        type: f.type.value, 
        price: Number(f.price.value||0),
        title: f.title.value.trim(), 
        description: f.desc.value.trim(),
        country: f.fcountry.value, 
        school: (f.school?.value||'').trim(),
        campus: f.campus.value.trim(), 
        contact: f.contact.value.trim(),
        urgent: !!f.urgent.checked, 
        owner_id: currentUser.id,
        status: 'open'
      };
      
      const { error } = await supabase
        .from('posts')
        .insert([data]);
      
      if (error) {
        console.error('Error creating post:', error);
        alert('发布失败');
        return;
      }
      
      renderMyPosts(); 
      renderPostsList(); 
      renderTradePosts();
      closePublish(); 
      alert('发布成功！'); 
      f.reset(); 
      syncCurrency();
    });

    // 帖子详情 / 完成 / 复制
    async function openPostDetail(postId){
      const { data: p, error } = await supabase
        .from('posts')
        .select('*')
        .eq('id', postId)
        .single();
      
      if (error) {
        console.error('Error fetching post:', error);
        return;
      }
      
      $('#detailTitle').textContent = p.title||'详情';
      $('#detailType').textContent  = postTypeName(p.type);
      $('#detailDesc').textContent  = p.description||'';
      $('#detailPrice').textContent = currencyFor(p.country)+(p.price||0);
      $('#detailCountry').textContent = p.country||'-';
      $('#detailSchool').textContent = p.school||'-';
      $('#detailCampus').textContent = p.campus||'-';
      $('#detailContact').textContent = p.contact||'-';
      $('#postDetail').classList.remove('hidden');
      $('#overlay').classList.remove('hidden');
      
      $('#copyContact').onclick = () => { 
        navigator.clipboard.writeText(p.contact||''); 
        alert('已复制联系方式'); 
      };
      
      $('#markDone').onclick = async () => {
        const { error } = await supabase
          .from('posts')
          .update({ status: 'done' })
          .eq('id', p.id);
        
        if (error) {
          console.error('Error marking post as done:', error);
          alert('标记失败');
          return;
        }
        
        renderMyPosts(); 
        renderPostsList(); 
        renderTradePosts(); 
        closePostDetail();
      };
      
      $('#openChatFromDetail').onclick = () => openChatRoom('post-'+p.id, p.title||'聊天');
    }
    
    function closePostDetail(){ $('#postDetail').classList.add('hidden'); }
    $('#closeDetail')?.addEventListener('click', closePostDetail);

    async function bindPostButtons(){
      // 给查看详情按钮添加事件
      $$('#postsList [data-open-detail], #taskList [data-open-detail], #errandsList [data-open-detail], #marketList [data-open-detail], #groupbuyList [data-open-detail]').forEach(btn => {
        btn.addEventListener('click', e => { 
          const id = e.currentTarget.dataset.openDetail; 
          openPostDetail(id); 
        });
      });
      
      // 给聊天按钮添加事件
      $$('#postsList [data-open-chat], #taskList [data-open-chat], #errandsList [data-open-chat], #marketList [data-open-chat], #groupbuyList [data-open-chat]').forEach(btn => {
        btn.addEventListener('click', e => openChatRoom('post-'+e.currentTarget.dataset.openChat, e.currentTarget.dataset.title||'聊天') );
      });
    }

    // ===== 院校评价数据 =====
    async function loadSchools() {
      const { data, error } = await supabase
        .from('schools')
        .select(`
          *,
          majors (*),
          school_reviews (*)
        `);
      
      if (error) {
        console.error('Error loading schools:', error);
        return [];
      }
      
      return data;
    }
    
    let sortKey='score', sortDir='desc', query='';
    const tbody=$('#reviewsTbody'); 
    const search=$('#reviewsSearch');
    
    function stars(n){
      const full=Math.max(0,Math.min(5,Math.round(n)));
      return '★★★★★'.slice(0,full)+'☆☆☆☆☆'.slice(0,5-full);
    }
    
    // 计算学校总体评分（基于专业+用户评价）
    function calcSchoolAverages(s){
      const arr = (s.majors||[]);
      if(!arr.length) return {course:0,life:0,career:0};
      
      const sum = arr.reduce((a,m)=>({
        course: a.course + (m.course_rating||0), 
        life: a.life + (m.life_rating||0), 
        career: a.career + (m.career_rating||0)
      }), {course:0,life:0,career:0});
      
      return {
        course: sum.course/arr.length, 
        life: sum.life/arr.length, 
        career: sum.career/arr.length
      };
    }
    
    function calcSchoolScore(school){
      const base = school.majors?.map(m => m.score).filter(Boolean) || [];
      const extra = (school.school_reviews||[]).map(x => x.score).filter(v => typeof v === 'number' && !isNaN(v));
      const all = base.concat(extra);
      
      if(!all.length) return 0;
      return all.reduce((a,b) => a + b, 0) / all.length;
    }
    
    async function renderReviews(){
      const schools = await loadSchools();
      
      let rows = schools.map(s => {
        const avg = calcSchoolAverages(s);
        return { 
          id: s.id,
          school: s.name, 
          score: calcSchoolScore(s) || 0, 
          course: avg.course, 
          life: avg.life, 
          career: avg.career 
        };
      });
      
      if(query){ 
        const q = query.toLowerCase(); 
        rows = rows.filter(r => r.school.toLowerCase().includes(q)); 
      }
      
      rows.sort((a,b) => { 
        const A = a[sortKey], B = b[sortKey]; 
        if(A === B) return 0; 
        return (sortDir === 'asc' ? (A > B ? 1 : -1) : (A < B ? 1 : -1)); 
      });
      
      tbody.innerHTML = rows.map(r => `
        <tr class="border-b hover:bg-[#fafafa]">
          <td class="py-3 px-4">${r.school}</td>
          <td class="py-3 px-4">${stars(r.course)}</td>
          <td class="py-3 px-4">${stars(r.life)}</td>
          <td class="py-3 px-4">${stars(r.career)}</td>
          <td class="py-3 px-4 font-semibold">${r.score ? r.score.toFixed(1) : '—'}</td>
          <td class="py-3 px-4"><button class="btn btn-outline" data-open-school="${r.id}">详情</button></td>
        </tr>
      `).join('');
      
      // 卡片视图也加入按钮
      $('#reviewsAll').innerHTML = rows.map(r => `
        <div class="tile p-4">
          <div class="font-semibold">${r.school}</div>
          <div class="mt-2 text-[14px]">课程强度：${stars(r.course)}</div>
          <div class="text-[14px]">生活便利：${stars(r.life)}</div>
          <div class="text-[14px]">就业资源：${stars(r.career)}</div>
          <div class="mt-1">综合评分：<b>${r.score ? r.score.toFixed(1) : '—'}</b></div>
          <button class="btn btn-outline mt-3" data-open-school="${r.id}">详情</button>
        </div>
      `).join('');
      
      $$('#reviewsAll [data-open-school], #reviewsTbody [data-open-school]').forEach(b => {
        b.addEventListener('click', e => openSchoolDetail(e.currentTarget.dataset.openSchool));
      });
    }
    
    search?.addEventListener('input', e => { 
      query = e.target.value.trim(); 
      renderReviews(); 
    });
    
    $$('#reviews thead [data-sort]').forEach(th => {
      th.addEventListener('click', () => { 
        const k = th.getAttribute('data-sort'); 
        sortDir = (sortKey === k && sortDir === 'desc') ? 'asc' : 'desc'; 
        sortKey = k; 
        renderReviews(); 
      });
    });

    // ===== 社区卡片 & 话题 =====
    async function loadTopics() {
      const { data, error } = await supabase
        .from('topics')
        .select('*')
        .order('created_at', { ascending: false });
      
      if (error) {
        console.error('Error loading topics:', error);
        return [];
      }
      
      return data;
    }
    
    function renderCommunityCards(){
      loadTopics().then(topics => {
        $('#communityCards').innerHTML = topics.slice(0,3).map(t => `
          <article class="tile p-6 cursor-pointer" data-page="${t.id}">
            <h4 class="font-semibold">${t.title}</h4>
            <p class="sub mt-1">${t.meta}</p>
            <button class="chat-action-btn mt-3" data-open-topic="${t.id}" data-title="${t.title}"><i class="fa-regular fa-comment-dots"></i> 加入讨论</button>
          </article>
        `).join('');
        
        $$('#communityCards [data-open-topic]').forEach(btn => {
          btn.addEventListener('click', e => openChatRoom(e.currentTarget.dataset.openTopic, e.currentTarget.dataset.title));
        });
      });
    }

    // 社区首页话题列表 + 发帖
    async function renderTopicHome(){
      const topics = await loadTopics();
      
      $('#topicList').innerHTML = topics.map(t => `
        <div class="border rounded p-3 mb-2">
          <div class="font-semibold">${t.title}</div>
          <div class="text-[13px] text-[#6e6e73]">${t.meta||''}</div>
          <div class="mt-2 flex gap-2">
            <button class="btn btn-outline" data-go-topic="${t.id}">查看</button>
            <button class="btn btn-black" data-topic-chat="${t.id}" data-title="${t.title}"><i class="fa-regular fa-comments"></i>&nbsp;聊天</button>
          </div>
        </div>
      `).join('');
      
      $$('#topicList [data-go-topic]').forEach(b => {
        b.addEventListener('click', e => openPage(e.currentTarget.dataset.goTopic));
      });
      
      $$('#topicList [data-topic-chat]').forEach(b => {
        b.addEventListener('click', e => openChatRoom(e.currentTarget.dataset.topicChat, e.currentTarget.dataset.title));
      });
    }
    
    $('#topicForm')?.addEventListener('submit', async e => {
      e.preventDefault();
      
      if(!currentUser){ 
        alert('请先登录'); 
        return; 
      }
      
      const title = $('#topicTitle').value.trim();
      const body = $('#topicBody').value.trim();
      
      if(!title || !body) return;
      
      const id = 'topic-'+Date.now();
      const meta = `${currentUser.email || '用户'} · 新话题`;
      
      const { error } = await supabase
        .from('topics')
        .insert([{ id, title, meta, body, created_by: currentUser.id }]);
      
      if (error) {
        console.error('Error creating topic:', error);
        alert('发布失败');
        return;
      }
      
      $('#topicTitle').value = '';
      $('#topicBody').value = '';
      renderTopicHome(); 
      alert('已发布');
    });

    // ===== 路由：打开/返回 =====
    function openPage(id){
      const page = document.querySelector('#page-'+id);
      if(!page){ return; }
      
      $$('#pageRouter .page').forEach(p => p.classList.remove('active'));
      page.classList.add('active');
      document.body.style.overflow = 'hidden';
      
      document.getElementById('reportSubmit')?.addEventListener('click', doReport);
      document.getElementById('reportCancel')?.addEventListener('click', closeReport);
    }
    
    function closePage(){ 
      $$('#pageRouter .page').forEach(p => p.classList.remove('active')); 
      document.body.style.overflow = 'auto'; 
    }
    
    $$('#pageRouter [data-back]').forEach(btn => {
      btn.addEventListener('click', closePage);
    });
    
    $$('#home [data-page], #trade [data-page], #resources [data-page], header [data-page]').forEach(el => {
      el.addEventListener('click', e => openPage(e.currentTarget.dataset.page));
    });

    // ===== 聊天（Supabase 实时功能） =====
    let currentRoom = null;
    let messageSubscription = null;
    
    // 加载聊天消息
    async function loadChatMessages(roomId) {
      const { data, error } = await supabase
        .from('chat_messages')
        .select(`
          *,
          profiles:user_id (email, wechat)
        `)
        .eq('room_id', roomId)
        .order('created_at', { ascending: true });
      
      if (error) {
        console.error('Error loading messages:', error);
        return [];
      }
      
      return data;
    }
    
    // 发送聊天消息
    async function sendChatMessage(roomId, text) {
      if (!currentUser) return;
      
      const { error } = await supabase
        .from('chat_messages')
        .insert([{
          room_id: roomId,
          user_id: currentUser.id,
          content: text
        }]);
      
      if (error) {
        console.error('Error sending message:', error);
        alert('发送失败');
      }
    }
    
    // 渲染聊天消息
    function renderChatMessages(messages) {
      const me = currentUser ? currentUser.id : null;
      
      $('#chatMessages').innerHTML = messages.map(m => `
        <div class="chat-item ${m.user_id === me ? 'chat-me' : ''}">
          <div class="chat-bubble">${m.content}</div>
          <div class="chat-meta">${m.profiles?.wechat || m.profiles?.email || '用户'} · ${new Date(m.created_at).toLocaleTimeString()}</div>
        </div>
      `).join('');
      
      $('#chatMessages').scrollTop = $('#chatMessages').scrollHeight;
    }
    
    // 打开聊天室
    async function openChatRoom(roomId, title) {
      // 取消之前的订阅
      if (messageSubscription) {
        supabase.removeChannel(messageSubscription);
      }
      
      currentRoom = roomId;
      $('#chatRoomTitle').textContent = title || '聊天';
      $('#chatRoomBadge').textContent = '#' + roomId;
      $('#chatPanel').classList.add('active');
      
      // 加载历史消息
      const messages = await loadChatMessages(roomId);
      renderChatMessages(messages);
      
      // 订阅新消息
      messageSubscription = supabase
        .channel('room-' + roomId)
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'chat_messages',
          filter: `room_id=eq.${roomId}`
        }, payload => {
          // 获取用户资料并渲染新消息
          supabase
            .from('profiles')
            .select('email, wechat')
            .eq('id', payload.new.user_id)
            .single()
            .then(({ data: profile }) => {
              const messageWithProfile = {
                ...payload.new,
                profiles: profile
              };
              
              const messagesContainer = $('#chatMessages');
              const isScrolledToBottom = messagesContainer.scrollHeight - messagesContainer.clientHeight <= messagesContainer.scrollTop + 50;
              
              const messageEl = document.createElement('div');
              messageEl.className = `chat-item ${payload.new.user_id === currentUser?.id ? 'chat-me' : ''}`;
              messageEl.innerHTML = `
                <div class="chat-bubble">${payload.new.content}</div>
                <div class="chat-meta">${profile?.wechat || profile?.email || '用户'} · ${new Date(payload.new.created_at).toLocaleTimeString()}</div>
              `;
              
              messagesContainer.appendChild(messageEl);
              
              if (isScrolledToBottom) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
              }
            });
        })
        .subscribe();
    }
    
    // 关闭聊天
    function closeChat(){ 
      $('#chatPanel').classList.remove('active'); 
      
      if (messageSubscription) {
        supabase.removeChannel(messageSubscription);
        messageSubscription = null;
      }
    }
    
    $('#closeChatBtn')?.addEventListener('click', closeChat);
    $('#chatSendBtn')?.addEventListener('click', () => {
      const text = $('#chatInput').value.trim(); 
      if(!text) return;
      
      sendChatMessage(currentRoom, text); 
      $('#chatInput').value = ''; 
    });
    
    $('#chatInput')?.addEventListener('keydown', e => { 
      if(e.key === 'Enter'){ 
        e.preventDefault(); 
        $('#chatSendBtn').click(); 
      } 
    });

    // 通用聊天入口按钮（右下角）打开默认大厅
    $('#chatToggleBtn')?.addEventListener('click', () => openChatRoom('lobby', '公共聊天'));

    // ===== 聊天大厅示例数据 =====
    async function renderTradeLobby(){
      const posts = await loadPosts();
      const recentPosts = posts.slice(0, 6);
      
      $('#tradeLobby').innerHTML = recentPosts.map(p => `
        <div class="chat-room-card">
          <div class="chat-room-header">
            <div class="chat-room-avatar">U</div>
            <div class="chat-room-title">${p.title}</div>
            <span class="chat-room-badge">#${postTypeName(p.type)}</span>
          </div>
          <div class="chat-room-body">
            <div class="chat-room-desc">${p.description}</div>
            <div class="chat-room-meta">
              <span><i class="fa-regular fa-user"></i> ${p.contact}</span>
              <span><i class="fa-regular fa-clock"></i> ${new Date(p.created_at).toLocaleDateString()}</span>
            </div>
          </div>
          <div class="chat-room-footer">
            <button class="chat-action-btn" data-open-chat-room="post-${p.id}" data-title="${p.title}">
              <i class="fa-regular fa-comment"></i> 加入聊天
            </button>
            <span class="text-[#6e6e73] text-sm">在线: ~</span>
          </div>
        </div>
      `).join('') || '<div class="text-[#6e6e73]">暂无活跃交易聊天，去发布一个？</div>';
      
      $$('#tradeLobby [data-open-chat-room]').forEach(b => {
        b.addEventListener('click', e => openChatRoom(e.currentTarget.dataset.openChatRoom, e.currentTarget.dataset.title));
      });
    }
    
    async function renderCommunityLobby(){
      const topics = await loadTopics();
      const recentTopics = topics.slice(0, 6);
      
      $('#communityLobby').innerHTML = recentTopics.map(t => `
        <div class="chat-room-card">
          <div class="chat-room-header">
            <div class="chat-room-avatar">U</div>
            <div class="chat-room-title">${t.title}</div>
            <span class="chat-room-badge">话题</span>
          </div>
          <div class="chat-room-body">
            <div class="chat-room-desc">${t.body?.slice(0,60) || '欢迎交流～'}</div>
            <div class="chat-room-meta">
              <span><i class="fa-regular fa-user"></i> ${t.meta || '社区'}</span>
            </div>
          </div>
          <div class="chat-room-footer">
            <button class="chat-action-btn" data-open-chat-room="${t.id}" data-title="${t.title}">
              <i class="fa-regular fa-comment"></i> 加入讨论
            </button>
            <span class="text-[#6e6e73] text-sm">在线: ~</span>
          </div>
        </div>
      `).join('');
      
      $$('#communityLobby [data-open-chat-room]').forEach(b => {
        b.addEventListener('click', e => openChatRoom(e.currentTarget.dataset.openChatRoom, e.currentTarget.dataset.title));
      });
    }

    // ===== 搜索/过滤 =====
    $('#taskSearch')?.addEventListener('input', async e => {
      const kw = e.target.value.toLowerCase();
      const posts = await loadPosts();
      const filteredPosts = posts.filter(p => p.type === 'task' && (p.title.toLowerCase().includes(kw) || p.description.toLowerCase().includes(kw)));
      
      $('#taskList').innerHTML = filteredPosts.map(cardHtml).join('') || '<div class="text-[#6e6e73]">未找到匹配任务</div>';
      bindPostButtons();
    });
    
    $('#taskCountryFilter')?.addEventListener('change', async e => {
      const c = e.target.value;
      const posts = await loadPosts();
      const filteredPosts = posts.filter(p => p.type === 'task' && (!c || p.country === c));
      
      $('#taskList').innerHTML = filteredPosts.map(cardHtml).join('') || '<div class="text-[#6e6e73]">暂无任务</div>';
      bindPostButtons();
    });

    // ===== 认证弹窗逻辑 =====
    function openVerify(){ 
      if(!currentUser){ 
        openAuth(); 
        return; 
      } 
      
      $('#overlay').classList.remove('hidden'); 
      $('#verifySheet').classList.remove('hidden'); 
      yearsOptions(); 
      updateCalcExpire(); 
    }
    
    function closeVerify(){ 
      $('#verifySheet').classList.add('hidden'); 
      if($('#overlay')) $('#overlay').classList.add('hidden'); 
    }
    
    function updateCalcExpire(){
      const y = Number($('#enrollYear')?.value || new Date().getFullYear());
      const years = Number($('#programYears')?.value || 4);
      const exp = computeExpire(y, years);
      const el = $('#calcExpire'); 
      
      if(el) el.textContent = new Date(exp).toLocaleDateString();
    }
    
    async function submitVerify(e){
      e.preventDefault();
      
      if(!currentUser){ 
        openAuth(); 
        return; 
      }
      
      const docType = (Array.from(document.querySelectorAll('input[name="docType"]')).find(r => r.checked)?.value) || 'enroll';
      const file = $('#verifyFile')?.files?.[0];
      const enroll_year = Number($('#enrollYear')?.value || new Date().getFullYear());
      const program_years = Number($('#programYears')?.value || 4);
      
      if(!file){ 
        alert('请上传在读证明或录取通知书'); 
        return; 
      }
      
      // 上传文件到 Supabase Storage
      const fileExt = file.name.split('.').pop();
      const fileName = `${currentUser.id}-${Date.now()}.${fileExt}`;
      const filePath = `verifications/${fileName}`;
      
      const { error: uploadError } = await supabase.storage
        .from('documents')
        .upload(filePath, file);
      
      if (uploadError) {
        console.error('Error uploading file:', uploadError);
        alert('文件上传失败');
        return;
      }
      
      // 获取文件公共URL
      const { data: { publicUrl } } = supabase.storage
        .from('documents')
        .getPublicUrl(filePath);
      
      const expires_at = computeExpire(enroll_year, program_years);
      
      // 更新用户认证信息
      const { error } = await supabase
        .from('profiles')
        .update({
          verification_level: 'strong',
          verification_method: docType,
          verification_file_name: file.name,
          verification_status: 'approved',
          verification_expires_at: expires_at,
          enroll_year: enroll_year,
          program_years: program_years,
          type: 'student',
          updated_at: new Date().toISOString()
        })
        .eq('id', currentUser.id);
      
      if (error) {
        console.error('Error updating verification:', error);
        alert('认证提交失败');
        return;
      }
      
      renderUser(); 
      closeVerify();
      alert('认证成功：有效期至 ' + new Date(expires_at).toLocaleDateString());
    }

    // 绑定事件
    $('#btnOpenVerify')?.addEventListener('click', openVerify);
    $('#btnReverify')?.addEventListener('click', openVerify);
    $('#goVerify')?.addEventListener('click', openVerify);
    $('#closeVerify')?.addEventListener('click', closeVerify);
    $('#verifyForm')?.addEventListener('submit', submitVerify);
    $('#enrollYear')?.addEventListener('change', updateCalcExpire);
    $('#programYears')?.addEventListener('change', updateCalcExpire);

    // ===== 院校详情渲染与评分 =====
    let _reportTarget = null; // {school, index}
    
    function openReport(schoolId, idx){
      _reportTarget = {schoolId, idx};
      document.getElementById('reportModal').classList.remove('hidden');
    }
    
    function closeReport(){
      document.getElementById('reportModal').classList.add('hidden');
      _reportTarget = null;
    }
    
    async function doReport(){
      if(!_reportTarget) return closeReport();
      
      const reason = document.getElementById('reportReason').value;
      const extra = document.getElementById('reportExtra').value.trim();
      
      // 获取当前评论
      const { data: reviews, error: fetchError } = await supabase
        .from('school_reviews')
        .select('*')
        .eq('school_id', _reportTarget.schoolId)
        .order('created_at', { ascending: false });
      
      if (fetchError) {
        console.error('Error fetching reviews:', fetchError);
        return;
      }
      
      const review = reviews[_reportTarget.idx];
      const currentReports = review.reports || [];
      
      // 更新举报信息
      const { error } = await supabase
        .from('school_reviews')
        .update({
          reports: [...currentReports, {
            reason, 
            extra, 
            ts: new Date().toISOString(), 
            by: currentUser?.email || currentUser?.wechat || '用户'
          }]
        })
        .eq('id', review.id);
      
      if (error) {
        console.error('Error updating reports:', error);
        alert('举报提交失败');
        return;
      }
      
      closeReport();
      openSchoolDetail(_reportTarget.schoolId);
      alert('已提交举报，我们会尽快处理。');
    }
    
    async function togglePin(schoolId, reviewId, currentlyPinned){
      const { error } = await supabase
        .from('school_reviews')
        .update({ pinned: !currentlyPinned })
        .eq('id', reviewId);
      
      if (error) {
        console.error('Error toggling pin:', error);
        alert('操作失败');
        return;
      }
      
      openSchoolDetail(schoolId);
    }

    async function openSchoolDetail(schoolId){
      // 获取学校详情
      const { data: school, error } = await supabase
        .from('schools')
        .select(`
          *,
          majors (*),
          school_reviews (*,
            profiles:user_id (email, wechat, verification_level, verification_expires_at)
          )
        `)
        .eq('id', schoolId)
        .single();
      
      if (error) {
        console.error('Error fetching school:', error);
        return;
      }
      
      const page = document.querySelector('#page-school-detail');
      if(!page) return;
      
      // 标题
      $('#schoolDetailTitle').textContent = school.name;
      
      // 概览
      const avg = calcSchoolScore(school);
      $('#schoolSummary').innerHTML = `<div class="flex items-center justify-between">
        <div>
          <div class="font-semibold text-lg">${school.name}</div>
          <div class="text-[14px] text-[#6e6e73]">共有 ${school.majors.length} 个专业（展示部分评分为示例）</div>
        </div>
        <div class="text-right">
          <div class="text-[13px] text-[#6e6e73]">综合评分</div>
          <div class="text-2xl font-bold">${avg ? avg.toFixed(1) : '—'}</div>
        </div>
      </div>`;
      
      // 专业列表
      $('#schoolMajors').innerHTML = school.majors.map(m => `
        <div class="border rounded p-3 mb-2">
          <div class="font-semibold">${m.name}</div>
          <div class="text-[14px] mt-1">课程强度：${stars(m.course_rating)} · 生活便利：${stars(m.life_rating)} · 就业资源：${stars(m.career_rating)}</div>
          <div class="text-[14px] mt-1">专业评分：<b>${m.score ? m.score.toFixed(1) : '—'}</b></div>
        </div>
      `).join('');
      
      // 学生评论列表（置顶优先 -> 已认证 -> 时间倒序）
      let reviews = school.school_reviews || [];
      reviews = reviews.sort((a, b) => {
        const pa = a.pinned ? 1 : 0, pb = b.pinned ? 1 : 0;
        if(pa !== pb) return pb - pa;
        
        const va = a.verified ? 1 : 0, vb = b.verified ? 1 : 0;
        if(va !== vb) return vb - va;
        
        return new Date(b.created_at) - new Date(a.created_at);
      });
      
      $('#schoolAvgScore').textContent = reviews.length ? `学生评论（${reviews.length}）` : '学生评论（0）';
      $('#schoolReviewsList').innerHTML = reviews.map((it, idx) => {
        const reportedCount = (it.reports || []).length;
        const imgs = (it.images || []).map(src => `<img src="${src}" alt="img">`).join('');
        
        return `<div class="border rounded p-3 ${reportedCount >= 3 ? 'cmt-reported' : ''}">
          <div class="flex items-center justify-between">
            <div class="font-semibold text-[14px]">${it.profiles?.wechat || it.profiles?.email || '匿名'} ${it.pinned ? '<span class="cmt-badge">置顶</span>' : ''}</div>
            <div class="text-[12px]">${it.verified ? '<span class="badge"><b>U</b> 已认证</span>' : '<span class="badge">未认证</span>'}</div>
          </div>
          ${typeof it.score === 'number' ? `<div class="text-[14px] mt-1">评分：<b>${it.score.toFixed(1)}</b></div>` : ''}
          <div class="text-[14px] mt-1">${it.text || ''}</div>
          ${imgs ? `<div class="cmt-images">${imgs}</div>` : ''}
          <div class="text-[12px] text-[#6e6e73] mt-1">${new Date(it.created_at).toLocaleString()} ${reportedCount ? `· 已被举报 ${reportedCount} 次` : ''}</div>
          <div class="cmt-actions">
            <button data-pin="${it.id},${it.pinned}">${it.pinned ? '取消置顶' : '置顶'}</button>
            <button data-report="${idx}">举报</button>
          </div>
        </div>`;
      }).join('') || '<div class="text-[#6e6e73]">还没有评论，来说两句吧～</div>';
      
      // 绑定置顶/举报
      $$('#schoolReviewsList [data-pin]').forEach(btn => {
        btn.addEventListener('click', e => {
          const [reviewId, currentlyPinned] = e.currentTarget.dataset.pin.split(',');
          togglePin(schoolId, reviewId, currentlyPinned === 'true');
        });
      });
      
      $$('#schoolReviewsList [data-report]').forEach(btn => {
        btn.addEventListener('click', e => openReport(schoolId, Number(e.currentTarget.dataset.report)));
      });
      
      // 评价表单
      if(currentUser){
        // 检查用户是否是已认证留学生
        const { data: profile } = await supabase
          .from('profiles')
          .select('verification_level, verification_expires_at')
          .eq('id', currentUser.id)
          .single();
        
        const canScore = profile.verification_level === 'strong' && 
                        (!profile.verification_expires_at || new Date(profile.verification_expires_at) > new Date());
        
        $('#schoolReviewFormWrap').innerHTML = `
          <form id="schoolReviewForm" class="grid gap-2">
            ${canScore ? `
              <div>
                <label class="block text-sm text-[#6e6e73] mb-1">打分（1-5，已认证留学生）</label>
                <input id="schoolScoreInput" type="number" min="1" max="5" step="1" value="5" class="w-full border rounded px-3 py-2"/>
              </div>` : ''}
            <div>
              <label class="block text-sm text-[#6e6e73] mb-1">评论</label>
              <textarea id="schoolTextInput" rows="2" class="w-full border rounded px-3 py-2" placeholder="分享你的真实体验…"></textarea>
            </div>
            <div>
              <label class="block text-sm text-[#6e6e73] mb-1">上传图片（最多3张，每张≤1.5MB）</label>
              <input id="schoolImgInput" type="file" accept=".jpg,.jpeg,.png" multiple/>
            </div>
            <div id="schoolImgPreview" class="cmt-images"></div>
            <button class="btn btn-black" type="submit">提交</button>
            <div class="help">${canScore ? '你的身份：已认证留学生，可评分并评论' : '你的身份：未认证 / 非留学生，可发表评论（评分仅限已认证留学生）'}</div>
          </form>
        `;
        
        $('#schoolImgInput')?.addEventListener('change', async e => {
          const files = e.target.files;
          const images = [];
          
          for (let i = 0; i < Math.min(files.length, 3); i++) {
            const file = files[i];
            if (file.size > 1.5 * 1024 * 1024) continue;
            
            // 上传图片到 Supabase Storage
            const fileExt = file.name.split('.').pop();
            const fileName = `${currentUser.id}-${Date.now()}-${i}.${fileExt}`;
            const filePath = `review-images/${fileName}`;
            
            const { error: uploadError } = await supabase.storage
              .from('images')
              .upload(filePath, file);
            
            if (uploadError) {
              console.error('Error uploading image:', uploadError);
              continue;
            }
            
            // 获取图片公共URL
            const { data: { publicUrl } } = supabase.storage
              .from('images')
              .getPublicUrl(filePath);
            
            images.push(publicUrl);
          }
          
          $('#schoolImgPreview').innerHTML = images.map(src => `<img src="${src}" alt="pre">`).join('');
        });
        
        $('#schoolReviewForm')?.addEventListener('submit', async e => {
          e.preventDefault();
          
          const text = ($('#schoolTextInput').value || '').trim();
          if(!text){ 
            alert('请填写评论'); 
            return; 
          }
          
          const scoreVal = canScore ? Number($('#schoolScoreInput').value || 5) : null;
          const score = canScore ? Math.max(1, Math.min(5, scoreVal)) : null;
          
          // 获取已上传的图片URL
          const images = Array.from($('#schoolImgPreview').querySelectorAll('img')).map(img => img.src);
          
          const { error } = await supabase
            .from('school_reviews')
            .insert([{
              school_id: schoolId,
              user_id: currentUser.id,
              score: score,
              text: text,
              images: images,
              verified: canScore
            }]);
          
          if (error) {
            console.error('Error creating review:', error);
            alert('提交失败');
            return;
          }
          
          openSchoolDetail(schoolId); // 重新渲染
          renderReviews(); // 列表页综合分更新
          alert('提交成功！');
        });
      } else {
        $('#schoolReviewFormWrap').innerHTML = '<div class="help">请先登录后发表评论；评分仅限已认证留学生。</div><button class="btn btn-outline mt-2" onclick="openAuth()">登录 / 注册</button>';
      }

      // 打开页面
      $$('#pageRouter .page').forEach(p => p.classList.remove('active'));
      page.classList.add('active');
      document.body.style.overflow = 'hidden';
      
      document.getElementById('reportSubmit')?.addEventListener('click', doReport);
      document.getElementById('reportCancel')?.addEventListener('click', closeReport);
    }

    // ===== 路由与页面切换绑定 =====
    document.querySelectorAll('[data-page]').forEach(btn => {
      btn.addEventListener('click', e => {
        e.preventDefault();
        const id = btn.getAttribute('data-page');
        if(id) openPage(id);
      });
    });
    
    document.querySelectorAll('[data-back]').forEach(btn => {
      btn.addEventListener('click', () => {
        $$('#pageRouter .page').forEach(p => p.classList.remove('active'));
        document.body.style.overflow = 'auto';
      });
    });

    // ===== 初始化数据 & 渲染 =====
    async function bootstrapDemoData(){
      // 检查是否有学校数据，没有则插入示例数据
      const { count, error } = await supabase
        .from('schools')
        .select('*', { count: 'exact', head: true });
      
      if (error) {
        console.error('Error checking schools:', error);
        return;
      }
      
      if (count === 0) {
        // 插入示例学校数据
        const { error: insertError } = await supabase
          .from('schools')
          .insert([
            { name: '延世大学', country: '韩国' },
            { name: '高丽大学', country: '韩国' },
            { name: '首尔大学', country: '韩国' }
          ]);
        
        if (insertError) {
          console.error('Error inserting schools:', insertError);
        }
      }
    }

    // 导航绑定（卡片点击打开页面）
    $$('#home [data-page], #trade [data-page]').forEach(el => {
      el.addEventListener('click', e => openPage(e.currentTarget.dataset.page));
    });

    // 初始渲染
    async function init(){
      await checkSession(); // 检查当前会话
      bootstrapDemoData(); 
      yearsOptions();
      renderUser();
      renderPostsList();
      renderTradePosts();
      renderCommunityCards();
      renderTopicHome();
      renderReviews();
      renderTradeLobby(); 
      refreshSyncLabel();
      renderCommunityLobby();
    }

    // 启动应用
    init();
  </script>
</body>
</html>