<!DOCTYPE html>
<html lang="zh" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Unilink｜留学生活 · 交易与社区</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <style>
    :root{ --brand:#1d1d1f; --ink:#1d1d1f; --sub:#6e6e73; --line:#d2d2d7; --bg:#ffffff; --bg-alt:#f5f5f7; --radius:20px; --ease:cubic-bezier(.2,.7,.2,1) }
    html,body{background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display','SF Pro Text','Helvetica Neue',Arial,sans-serif;scroll-behavior:smooth}
    .container-apple{max-width:1200px;margin:0 auto;padding:0 24px}
    .glass{backdrop-filter:saturate(180%) blur(20px);background:rgba(255,255,255,.82)}
    .eyebrow{letter-spacing:.08em;text-transform:uppercase;font-size:12px;color:var(--sub);font-weight:700}
    .h1{font-size:64px;line-height:1.02;letter-spacing:-.02em;font-weight:800}
    .h2{font-size:36px;line-height:1.1;letter-spacing:-.01em;font-weight:700}
    .sub{font-size:17px;color:var(--sub)}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:14px 22px;border-radius:999px;font-weight:600;transition:transform .2s var(--ease),box-shadow .3s var(--ease),background .3s var(--ease)}
    .btn-black{background:var(--brand);color:#fff}
    .btn-black:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.15)}
    .btn-outline{border:1px solid var(--brand);color:var(--brand);background:#fff}
    .btn-outline:hover{background:var(--brand);color:#fff;transform:translateY(-2px)}
    .tile{border-radius:var(--radius);border:1px solid var(--line);background:#fff;transition:transform .25s var(--ease),box-shadow .3s var(--ease),border-color .2s var(--ease)}
    .tile:hover{transform:translateY(-4px);box-shadow:0 16px 40px rgba(0,0,0,.06);border-color:#bcbcc2}
    .hero{position:relative;overflow:hidden;background:linear-gradient(180deg,#fff,#f7f7f9)}
    .hero-inner{position:relative;z-index:2;padding:120px 0;text-align:center;color:var(--ink)}
    .brand-badge{display:inline-flex;align-items:center;gap:8px;background:rgba(0,0,0,.04);backdrop-filter:saturate(160%) blur(6px);border:1px solid #e5e5ea;border-radius:14px;padding:8px 12px;color:var(--ink)}
    .brand-badge .dot{width:8px;height:8px;border-radius:50%;background:var(--brand)}
    .drawer{position:fixed;right:0;top:0;height:100vh;width:360px;max-width:92vw;background:#fff;border-left:1px solid var(--line);box-shadow:-20px 0 60px rgba(0,0,0,.12);transform:translateX(100%);transition:transform .3s var(--ease);z-index:70}
    .drawer.active{transform:translateX(0)}
    .drawer header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line)}
    @keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .fade{animation:fadeUp .6s var(--ease) both}
    .d1{animation-delay:.08s}.d2{animation-delay:.16s}.d3{animation-delay:.24s}
    :focus-visible{outline:3px solid #2688ff; outline-offset:2px; border-radius:10px}
    .table-wrap{overflow:auto}
    @media (max-width:1024px){.h1{font-size:44px}.h2{font-size:28px}.hero-inner{padding:96px 0}}
    @media (max-width:640px){.h1{font-size:34px}.h2{font-size:22px}.hero-inner{padding:72px 0}}
    .seg{display:inline-flex;background:#fff;border:1px solid var(--line);border-radius:999px;padding:4px}
    .seg input{position:absolute;opacity:0;pointer-events:none}
    .seg label{position:relative;cursor:pointer;min-width:90px;text-align:center;padding:8px 14px;border-radius:999px;font-weight:600;color:var(--sub);transition:all .2s var(--ease)}
    .seg input:checked + label{background:var(--brand);color:#fff;box-shadow:0 6px 16px rgba(0,0,0,.12)}
    .seg label:hover{color:#111}
    .country-dropdown{position:relative;min-width:140px}
    .country-dropdown select{width:100%;padding:10px 16px;border-radius:12px;border:1px solid var(--line);appearance:none;background:white;font-size:14px;font-weight:500}
    .country-dropdown:after{content:"";position:absolute;right:12px;top:50%;transform:translateY(-50%);width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:5px solid var(--sub);pointer-events:none}
    .page{position:fixed;inset:0;background:#fff;z-index:80;opacity:0;transform:translateX(100%);transition:transform .35s var(--ease), opacity .35s var(--ease);pointer-events:none}
    .page.active{opacity:1;transform:translateX(0);pointer-events:auto}
    .page-header{display:flex;align-items:center;gap:12px;padding:16px 24px;border-bottom:1px solid var(--line);background:#fff}
    .page-content{padding:24px;overflow-y:auto;height:calc(100vh - 70px)}
    .help{font-size:12px;color:#6e6e73}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid #e5e5ea;background:#fafafa;font-size:12px}
  
    /* 聊天相关样式 */
    .chat-panel{position:fixed;right:16px;bottom:16px;z-index:90;width:min(420px,92vw);height:520px;border:1px solid var(--line);border-radius:16px;background:#fff;box-shadow:0 12px 40px rgba(0,0,0,.15);display:none;flex-direction:column}
    .chat-panel.active{display:flex}
    .chat-header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--line)}
    .chat-body{flex:1;overflow:auto;padding:12px}
    .chat-item{margin:8px 0;display:flex;gap:8px}
    .chat-me{justify-content:flex-end}
    .chat-bubble{max-width:75%;padding:10px 12px;border-radius:14px;border:1px solid #e5e5ea;background:#fafafa;font-size:14px;line-height:1.4}
    .chat-me .chat-bubble{background:#111;color:#fff;border-color:#111}
    .chat-meta{font-size:11px;color:#6e6e73;margin-top:2px}
    .chat-input{display:flex;gap:8px;padding:10px;border-top:1px solid var(--line);background:#fff}
    .chat-input input{flex:1;border:1px solid var(--line);border-radius:999px;padding:10px 14px}
    
    /* 聊天大厅样式 */
    .chat-lobby{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;padding:16px}
    .chat-room-card{display:flex;flex-direction:column;border:1px solid var(--line);border-radius:12px;overflow:hidden;transition:all .2s var(--ease)}
    .chat-room-card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.08)}
    .chat-room-header{padding:12px;background:var(--bg-alt);display:flex;align-items:center;gap:8px}
    .chat-room-body{padding:12px;display:flex;flex-direction:column;gap:8px}
    .chat-room-footer{padding:12px;border-top:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    .chat-room-avatar{width:40px;height:40px;border-radius:50%;background:var(--brand);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:bold}
    .chat-room-title{font-weight:600;flex:1}
    .chat-room-desc{font-size:14px;color:var(--sub);line-height:1.4}
    .chat-room-meta{display:flex;align-items:center;gap:12px;font-size:13px;color:var(--sub)}
    .chat-room-meta i{margin-right:4px}
    .chat-room-badge{background:var(--brand);color:#fff;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:600}
    .chat-tab-bar{display:flex;border-bottom:1px solid var(--line);background:#fff}
    .chat-tab{flex:1;text-align:center;padding:12px;font-weight:600;color:var(--sub);transition:all .2s var(--ease);border-bottom:2px solid transparent}
    .chat-tab.active{color:var(--brand);border-bottom-color:var(--brand)}
    
    /* 新添加的样式 */
    .chat-toggle-btn{position:fixed;right:16px;bottom:80px;width:52px;height:52px;border-radius:50%;background:var(--brand);color:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(0,0,0,.15);z-index:80;transition:transform .2s var(--ease)}
    .chat-toggle-btn:hover{transform:scale(1.05)}
    .chat-indicator{position:absolute;top:-4px;right:-4px;width:18px;height:18px;border-radius:50%;background:#ff3b30;color:#fff;font-size:11px;display:flex;align-items:center;justify-content:center}
    .chat-action-btn{display:inline-flex;align-items:center;gap:4px;padding:6px 12px;border-radius:999px;background:var(--bg-alt);font-size:13px;font-weight:500;color:var(--ink);transition:all .2s var(--ease)}
    .chat-action-btn:hover{background:#e5e5ea}
  </style>
</head>
<body>
  <a href="#home" class="sr-only focus:not-sr-only focus:fixed focus:top-2 focus:left-2 bg-[var(--brand)] text-white px-3 py-1 rounded z-[100]">跳到主要内容</a>

  <header class="sticky top-0 z-50 glass border-b border-[#e5e5ea]">
    <div class="container-apple py-3 flex items-center justify-between">
      <a href="#home" class="flex items-center gap-2" aria-label="Unilink 首页">
        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-[var(--brand)] text-white text-sm font-bold">U</span>
        <b>Unilink</b>
      </a>
      <nav class="hidden md:flex items-center gap-6 text-[15px]" aria-label="主导航">
        <a class="hover:opacity-70" href="#trade">交易</a>
        <a class="hover:opacity-70" href="#community">社区</a>
        <a class="hover:opacity-70" href="#reviews">院校评价</a>
        <a class="hover:opacity-70" href="#resources">服务中心</a>
      </nav>
      <div class="flex items-center gap-3">
        <button id="publishBtnTop" class="btn btn-black">发布</button>
        <button id="avatarBtn" class="w-9 h-9 rounded-full border flex items-center justify-center" aria-label="打开个人菜单">
          <i class="fa-regular fa-user"></i>
        </button>
      </div>
    </div>
  </header>

  <main>
    <section id="home" class="hero">
      <div class="container-apple hero-inner">
        <div class="brand-badge fade mx-auto"><span class="dot"></span><span class="text-[13px]">留学中 · 品牌主阵地</span></div>
        <h1 class="h1 mt-6 fade d1">留学生活，从这里连接</h1>
        <p class="sub mt-3 max-w-2xl mx-auto fade d2">交易、社区与院校评价的统一入口。为在校留学生提供跑腿代购、二手交易、经验交流与择校参考。</p>
        <div class="mt-8 flex flex-wrap justify-center gap-4 fade d3">
          <button class="btn btn-black" data-page="taskhall">进入交易</button>
          <button class="btn btn-outline" data-page="community-home">进入社区</button>
          <button class="btn btn-outline" data-page="reviews-all">院校评价</button>
        </div>
      </div>
    </section>

    <section id="trade" class="py-20 bg-[var(--bg)]">
      <div class="container-apple">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-6">
          <div>
            <div class="eyebrow">TRADE</div>
            <h2 class="h2 mt-1">交易 · 任务 / 跑腿 / 二手 / 团购</h2>
            <p class="sub mt-1">面向留学中用户的高频刚需，平台撮合更高效</p>
          </div>
          <div class="flex items-center gap-3">
            <button class="btn btn-outline" id="publishBtnTrade">发布需求</button>
            <button class="chat-action-btn" data-page="trade-chat-lobby">
              <i class="fa-regular fa-comments"></i> 交易聊天
            </button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
          <a class="tile p-6 block cursor-pointer" data-page="taskhall"><h3 class="font-semibold text-lg">任务大厅</h3><p class="sub mt-1">悬赏占座、搬运行李、代购</p></a>
          <a class="tile p-6 block cursor-pointer" data-page="errands"><h3 class="font-semibold text-lg">跑腿代购</h3><p class="sub mt-1">校内 30 分钟达 · 实时位置</p></a>
          <a class="tile p-6 block cursor-pointer" data-page="market"><h3 class="font-semibold text-lg">二手市场</h3><p class="sub mt-1">真图真价 · 当面验货</p></a>
          <a class="tile p-6 block cursor-pointer" data-page="groupbuy"><h3 class="font-semibold text-lg">校园团购</h3><p class="sub mt-1">本地商家拼单优惠</p></a>
        </div>

        <div>
          <div class="flex items-center justify-between mb-3">
            <h3 class="h2">最新发布</h3>
            <button id="refreshPosts" class="text-[14px] text-[#6e6e73] hover:text-black">刷新</button>
          </div>
          <div id="postsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <div class="mt-12">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-lg">来自我的发布</h3>
            <button class="text-[14px] text-[#6e6e73] hover:text-black" id="clearMyPosts">清空</button>
          </div>
          <div id="tradeMyPosts" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
          <div id="tradeMyPostsEmpty" class="text-[#6e6e73]">暂无内容，点击上方"发布需求"试试～</div>
        </div>
      </div>
    </section>

    <section id="community" class="py-20 bg-[var(--bg-alt)]">
      <div class="container-apple">
        <div class="flex items-end justify-between mb-6">
          <div>
            <div class="eyebrow">COMMUNITY</div>
            <h2 class="h2 mt-1">社区 · 热门话题与活动</h2>
            <p class="sub mt-1">真实交流，沉淀高质量经验与口碑</p>
          </div>
          <div class="flex items-center gap-3">
            <button class="btn btn-outline" data-page="community-home">进入社区</button>
            <button class="chat-action-btn" data-page="community-chat-lobby">
              <i class="fa-regular fa-comments"></i> 社区聊天
            </button>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <article class="tile p-6 cursor-pointer" data-page="topic-exam">
            <h4 class="font-semibold">期末高效复习法</h4>
            <p class="sub mt-1">延世 · 计算机 · 120 评论</p>
            <button class="chat-action-btn mt-3" data-open-topic-chat data-room="topic-exam" data-title="期末高效复习法">
              <i class="fa-regular fa-comment-dots"></i> 加入讨论
            </button>
          </article>
          <article class="tile p-6 cursor-pointer" data-page="topic-job">
            <h4 class="font-semibold">校内兼职怎么找？</h4>
            <p class="sub mt-1">高丽 · 商学院 · 78 评论</p>
            <button class="chat-action-btn mt-3" data-open-topic-chat data-room="topic-job" data-title="校内兼职怎么找？">
              <i class="fa-regular fa-comment-dots"></i> 加入讨论
            </button>
          </article>
          <article class="tile p-6 cursor-pointer" data-page="topic-rent">
            <h4 class="font-semibold">2025 租房避坑指南</h4>
            <p class="sub mt-1">首尔 · 住房 · 233 评论</p>
            <button class="chat-action-btn mt-3" data-open-topic-chat data-room="topic-rent" data-title="2025 租房避坑指南">
              <i class="fa-regular fa-comment-dots"></i> 加入讨论
            </button>
          </article>
        </div>
      </div>
    </section>

    <section id="reviews" class="py-20 bg-[var(--bg)]">
      <div class="container-apple">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-6">
          <div>
            <div class="eyebrow">REVIEWS</div>
            <h2 class="h2 mt-1">院校评价（Beta）</h2>
            <p class="sub mt-1">按院校/专业/维度查看真实体验，可搜索与排序</p>
          </div>
          <div class="flex items-center gap-3">
            <div class="relative">
              <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-[#6e6e73]"></i>
              <input id="reviewsSearch" class="pl-9 pr-3 py-2 border rounded-full text-[15px]" placeholder="搜索：院校/专业" />
            </div>
            <button class="btn btn-outline" data-page="reviews-all">查看全部院校</button>
          </div>
        </div>
        <div class="tile table-wrap">
          <table class="min-w-full text-[15px]">
            <thead class="bg-[#fafafa] border-b select-none">
              <tr>
                <th scope="col" class="text-left py-3 px-4 cursor-pointer" data-sort="school">院校</th>
                <th scope="col" class="text-left py-3 px-4 cursor-pointer" data-sort="major">专业</th>
                <th scope="col" class="text-left py-3 px-4 cursor-pointer" data-sort="course">课程强度</th>
                <th scope="col" class="text-left py-3 px-4 cursor-pointer" data-sort="life">生活便利</th>
                <th scope="col" class="text-left py-3 px-4 cursor-pointer" data-sort="career">就业资源</th>
                <th scope="col" class="text-left py-3 px-4 cursor-pointer" data-sort="score">总体评分</th>
              </tr>
            </thead>
            <tbody id="reviewsTbody" aria-live="polite"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="resources" class="py-20 bg-[var(--bg-alt)]">
      <div class="container-apple">
        <h2 class="h2">常用服务</h2>
        <p class="sub mt-1 mb-6">签证/住宿/校务/兼职等入口</p>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-6">
          <a class="tile p-6 text-center cursor-pointer" data-page="svc-campus"><i class="fa-solid fa-id-card text-2xl mb-2"></i><div class="font-semibold">学生证/校车</div><div class="sub">校务与交通</div></a>
          <a class="tile p-6 text-center cursor-pointer" data-page="svc-visa"><i class="fa-solid fa-shield-halved text-2xl mb-2"></i><div class="font-semibold">签证/居留</div><div class="sub">出入境相关</div></a>
          <a class="tile p-6 text-center cursor-pointer" data-page="svc-housing"><i class="fa-solid fa-house-chimney text-2xl mb-2"></i><div class="font-semibold">住宿/租房</div><div class="sub">校内外房源</div></a>
          <a class="tile p-6 text-center cursor-pointer" data-page="svc-jobs"><i class="fa-solid fa-briefcase text-2xl mb-2"></i><div class="font-semibold">兼职/实习</div><div class="sub">岗位与内推</div></a>
          <a class="tile p-6 text-center cursor-pointer" data-page="membership"><i class="fa-solid fa-crown text-2xl mb-2"></i><div class="font-semibold">会员中心</div><div class="sub">VIP 特权与管理</div></a>
        </div>
      </div>
    </section>
  </main>

  <footer class="border-t">
    <div class="container-apple py-10 text-[13px] text-[#6e6e73]">© 2025 Unilink · 留学生活 · 交易与社区</div>
  </footer>

  <nav id="mobileTabs" class="md:hidden fixed bottom-0 inset-x-0 bg-white/90 backdrop-blur border-t z-40" style="padding-bottom:env(safe-area-inset-bottom)">
    <div class="grid grid-cols-5 text-sm text-[#6e6e73]">
      <a href="#home" class="flex flex-col items-center py-2"><i class="fa-solid fa-house"></i><span>首页</span></a>
      <a href="#trade" class="flex flex-col items-center py-2"><i class="fa-solid fa-bag-shopping"></i><span>交易</span></a>
      <a href="#community" class="flex flex-col items-center py-2"><i class="fa-solid fa-people-group"></i><span>社区</span></a>
      <a href="#reviews" class="flex flex-col items-center py-2"><i class="fa-solid fa-graduation-cap"></i><span>院校</span></a>
      <a href="#resources" class="flex flex-col items-center py-2"><i class="fa-solid fa-gear"></i><span>我的</span></a>
    </div>
  </nav>

  <!-- 用户抽屉 -->
  <aside id="userDrawer" class="drawer" role="dialog" aria-modal="true" aria-labelledby="userPanelTitle">
    <header class="px-5 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-[var(--brand)] text-white flex items-center justify-center">U</div>
        <div>
          <div class="font-semibold" id="userPanelTitle">未登录用户</div>
          <div class="text-[12px] text-[#6e6e73]">点击下方登录 / 注册</div>
          <div id="userVipBadge" class="mt-1 hidden text-[12px]"><span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full border"><i class="fa-solid fa-crown"></i><span id="vipText">VIP</span></span></div>
        </div>
      </div>
      <button id="closeDrawerBtn" class="text-[#6e6e73]" aria-label="关闭"><i class="fas fa-times"></i></button>
    </header>
    <div class="p-5 space-y-2 text-[15px]">
      <a href="#trade" class="flex items-center gap-3 p-3 rounded-lg hover:bg-[#f5f5f7]"><i class="fa-solid fa-bag-shopping w-5 text-center"></i>交易</a>
      <a href="#community" class="flex items-center gap-3 p-3 rounded-lg hover:bg-[#f5f5f7]"><i class="fa-solid fa-people-group w-5 text-center"></i>社区</a>
      <a href="#reviews" class="flex items-center gap-3 p-3 rounded-lg hover:bg-[#f5f5f7]"><i class="fa-solid fa-graduation-cap w-5 text-center"></i>院校评价</a>
      <a href="#resources" class="flex items-center gap-3 p-3 rounded-lg hover:bg-[#f5f5f7]"><i class="fa-solid fa-book-open w-5 text-center"></i>服务中心</a>
      <a href="#membership" class="flex items-center gap-3 p-3 rounded-lg hover:bg-[#f5f5f7]"><i class="fa-solid fa-crown w-5 text-center"></i>会员中心</a>
      <div class="h-px bg-[#e5e5ea] my-3"></div>
      <button class="w-full btn btn-outline" id="loginBtn">登录 / 注册</button>
      <button class="w-full btn btn-outline hidden" id="logoutBtn">退出登录</button>
      <div class="h-px bg-[#e5e5ea] my-3"></div>
      <div>
        <div class="font-semibold mb-2">我的发布</div>
        <div id="myPosts" class="space-y-2 text-[14px]"><div class="text-[#6e6e73]" id="myPostsEmpty">暂无发布内容</div></div>
      </div>
    </div>
  
    <div class="tile p-4 border rounded-xl mx-5 mt-4">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <div class="font-semibold">会员中心</div>
          <div id="memberLevelText" style="font-size:13px;color:#6e6e73">Free（普通用户）</div>
        </div>
        <span id="memberBadge" class="vip-badge" style="display:none"><i class="fa-solid fa-crown"></i> VIP</span>
      </div>
      <div id="memberExpire" style="font-size:12px;color:#6e6e73;margin-top:6px">到期时间：—</div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="btnUpgradeVIP" class="btn btn-black" style="flex:1">开通 VIP（模拟）</button>
        <button id="btnDowngrade" class="btn btn-outline" style="flex:1;display:none">取消 VIP（模拟）</button>
      </div>
    </div>
  </aside>

  <!-- 遮罩与弹层 -->
  <div id="overlay" class="fixed inset-0 bg-black/40 hidden z-[60]"></div>

  <!-- 发布表单 -->
  <div id="publishSheet" class="fixed left-1/2 -translate-x-1/2 bottom-4 w-[92%] max-w-xl bg-white rounded-2xl shadow-2xl border p-6 z-[70] hidden">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-semibold">发布到 Unilink</h3>
      <button id="closePublish" class="text-[#6e6e73]" aria-label="关闭"><i class="fas fa-times"></i></button>
    </div>
    <form id="publishForm" class="grid gap-4">
      <div class="grid md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm text-[#6e6e73] mb-1">类型</label>
          <div class="relative">
            <select name="type" class="w-full rounded-xl border border-[#d2d2d7] bg-white px-4 py-2.5 text-[15px] appearance-none focus:outline-none focus:ring-2 focus:ring-black/10 focus:border-[var(--brand)]">
              <option value="errand">跑腿/代购</option>
              <option value="market">二手转让</option>
              <option value="task">悬赏任务</option>
            </select>
            <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-[#6e6e73] pointer-events-none"></i>
          </div>
        </div>
        <div>
          <label class="block text-sm text-[#6e6e73] mb-1">预算/价格（<span id="currencyUnit">$</span>）</label>
          <input name="price" id="priceInput" type="number" min="0" step="1" class="w-full rounded-xl border border-[#d2d2d7] bg-white px-4 py-2.5 text-[15px] focus:outline-none focus:ring-2 focus:ring-black/10 focus:border-[var(--brand)]" required />
        </div>
        <div>
          <label class="block text-sm text-[#6e6e73] mb-1">国家/地区</label>
          <div class="relative">
            <select name="fcountry" id="countrySelect" class="w-full rounded-xl border border-[#d2d2d7] bg-white px-4 py-2.5 text-[15px] appearance-none focus:outline-none focus:ring-2 focus:ring-black/10 focus:border-[var(--brand)]"></select>
            <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-[#6e6e73] pointer-events-none"></i>
          </div>
        </div>
      </div>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm text-[#6e6e73] mb-1">院校（按国家联动）</label>
          <input name="school" id="schoolInput" list="schoolList" class="w-full rounded-xl border border-[#d2d2d7] bg-white px-4 py-2.5 text-[15px]" placeholder="选择或输入院校名" />
          <datalist id="schoolList"></datalist>
          <div class="help mt-1">数据来自「中留学服」标准库（可扩展）。</div>
        </div>
        <div>
          <label class="block text-sm text-[#6e6e73] mb-1">校区/城市</label>
          <input name="campus" class="w-full rounded-xl border border-[#d2d2d7] bg-white px-4 py-2.5 text-[15px]" placeholder="如：嘉泉大学" />
        </div>
      </div>
      <div>
        <label class="block text-sm text-[#6e6e73] mb-1">标题</label>
        <input name="title" class="w-full rounded-xl border border-[#d2d2d7] bg-white px-4 py-2.5 text-[15px]" placeholder="例如：求帮忙取快递 / 出闲置 iPad" required />
      </div>
      <div>
        <label class="block text-sm text-[#6e6e73] mb-1">详细说明</label>
        <textarea name="desc" rows="3" class="w-full rounded-xl border border-[#d2d2d7] bg-white px-4 py-2.5 text-[15px]" placeholder="补充时间、地点、规格等信息" required></textarea>
      </div>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm text-[#6e6e73] mb-1">联系方式</label>
          <input name="contact" class="w-full rounded-xl border border-[#d2d2d7] bg-white px-4 py-2.5 text-[15px]" placeholder="微信/手机号" required />
        </div>
        <div class="flex flex-col gap-1">
          <label class="inline-flex items-center gap-2 text-sm mt-6">
            <input type="checkbox" name="urgent" id="urgentChk"/> 紧急（自动同步）
            <span class="badge" title="勾选后将在每天固定时间自动同步到微信社区，提升曝光，适合时间敏感的任务"> <i class="fa-regular fa-circle-question"></i> 说明 </span>
          </label>
          <div class="help">同步频次：每天一次 · 同步时间：<span id="syncTimeLbl">20:00（首尔）</span> · 目标：已绑定的微信社区</div>
        </div>
      </div>
      <div class="flex items-center justify-between">
        <div class="help">发布即代表你同意平台社区规范。</div>
        <button class="btn btn-black" type="submit">发布</button>
      </div>
    </form>
  </div>

  <!-- 详情弹窗 -->
  <div id="postDetail" class="fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[92%] max-w-lg bg-white rounded-2xl shadow-2xl border p-6 z-[80] hidden">
    <div class="flex items-center justify-between mb-3"><h3 id="detailTitle" class="text-lg font-semibold">详情</h3><button id="closeDetail" class="text-[#6e6e73]" aria-label="关闭"><i class="fas fa-times"></i></button></div>
    <div class="space-y-2 text-[15px]">
      <div class="text-[#6e6e73]" id="detailType">—</div>
      <div id="detailDesc">—</div>
      <div class="text-[14px]">价格：<b id="detailPrice">—</b></div>
      <div class="text-[14px]">国家：<span id="detailCountry">—</span></div>
      <div class="text-[14px]">院校：<span id="detailSchool">—</span></div>
      <div class="text-[14px]">校区：<span id="detailCampus">—</span></div>
      <div class="text-[14px]">联系方式：<span id="detailContact">—</span></div>
    </div>
    <div class="mt-4 flex gap-2">
      <button id="copyContact" class="btn btn-outline flex-1">复制联系方式</button>
      <button id="openChatFromDetail" class="btn btn-outline flex-1">
        <i class="fa-regular fa-comments"></i> 发起聊天
      </button>
      <button id="markDone" class="btn btn-black flex-1">标记完成</button>
    </div>
  </div>

  <!-- 登录弹窗 -->
  <div id="authSheet" class="fixed left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2 w-[92%] max-w-md bg-white rounded-2xl shadow-2xl border p-6 z-[90] hidden">
    <div class="flex items-center justify-between mb-3"><h3 class="text-lg font-semibold">登录 / 注册</h3><button id="closeAuth" class="text-[#6e6e73]" aria-label="关闭"><i class="fas fa-times"></i></button></div>
    <div class="space-y-4">
      <div>
        <div class="text-sm text-[#6e6e73] mb-2">选择用户类型</div>
        <div class="seg" id="segUserType">
          <input type="radio" name="ut" id="ut_student" value="student" checked><label for="ut_student">留学生用户</label>
          <input type="radio" name="ut" id="ut_other" value="other"><label for="ut_other">其他用户</label>
        </div>
      </div>
      <div id="authEmailWrap">
        <label class="block text-sm text-[#6e6e73] mb-1">邮箱（留学生必填）</label>
        <input id="emailInput" type="email" class="w-full rounded-xl border border-[#d2d2d7] bg-white px-4 py-2.5 text-[15px]" placeholder="you@example.com" />
      </div>
      <div id="authWechatWrap">
        <label class="block text-sm text-[#6e6e73] mb-1">微信（所有用户必填）</label>
        <input id="wechatInput" type="text" class="w-full rounded-xl border border-[#d2d2d7] bg-white px-4 py-2.5 text-[15px]" placeholder="微信号" />
      </div>
      <div class="flex gap-2">
        <button id="doLogin" class="btn btn-black flex-1">确认登录</button>
        <button id="doLogout" class="btn btn-outline flex-1 hidden">退出</button>
      </div>
      <div class="text-[13px] text-[#6e6e73]">说明：留学生需填写邮箱 + 微信进行验证；其他用户仅需填写微信。若已配置 Supabase，将向邮箱发送登录链接进行校验。</div>
    </div>
  </div>

  <!-- 路由页面 -->
  <div id="pageRouter">
    <!-- 原有页面保持不变 -->
    <section id="page-taskhall" class="page">
      <div class="page-header">
        <button class="btn btn-outline" data-back><i class="fas fa-arrow-left"></i></button>
        <h3 class="h2">任务大厅</h3>
      </div>
      <div class="page-content">
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-3">
            <div class="relative">
              <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-[#6e6e73]"></i>
              <input id="taskSearch" class="pl-9 pr-3 py-2 border rounded-full text-[15px]" placeholder="搜索任务..." />
            </div>
            <div class="country-dropdown"><select id="taskCountryFilter"></select></div>
          </div>
          <button class="btn btn-black" id="publishTaskBtn">发布任务</button>
        </div>
        <div id="taskList"></div>
      </div>
    </section>

    <section id="page-errands" class="page"><div class="container-apple py-6"><div class="flex items-center justify-between mb-4"><h3 class="h2">跑腿代购</h3><button class="btn btn-outline" data-back>返回</button></div><div id="errandsList" class="grid gap-4"></div></div></section>
    <section id="page-market" class="page"><div class="container-apple py-6"><div class="flex items-center justify-between mb-4"><h3 class="h2">二手市场</h3><button class="btn btn-outline" data-back>返回</button></div><div id="marketList" class="grid gap-4"></div></div></section>
    <section id="page-groupbuy" class="page"><div class="container-apple py-6"><div class="flex items-center justify之间 mb-4"><h3 class="h2">校园团购</h3><button class="btn btn-outline" data-back>返回</button></div><div id="groupbuyList" class="grid gap-4"></div></div></section>

    <section id="page-community-home" class="page"><div class="container-apple py-6"><div class="flex items-center justify-between mb-4"><h3 class="h2">社区首页</h3><button class="btn btn-outline" data-back>返回</button></div><p class="sub">（预留）将接入话题流与发帖。</p></div></section>
    <section id="page-topic-exam" class="page"><div class="container-apple py-6"><div class="flex items-center justify-between mb-4"><h3 class="h2">话题：期末高效复习法</h3><button class="btn btn-outline" data-back>返回</button></div><p class="sub">（预留）话题详情。</p></div></section>
    <section id="page-topic-job" class="page"><div class="container-apple py-6"><div class="flex items-center justify-between mb-4"><h3 class="h2">话题：校内兼职怎么找？</h3><button class="btn btn-outline" data-back>返回</button></div><p class="sub">（预留）话题详情。</p></div></section>
    <section id="page-topic-rent" class="page"><div class="container-apple py-6"><div class="flex items-center justify-between mb-4"><h3 class="h2">话题：2025 租房避坑指南</h3><button class="btn btn-outline" data-back>返回</button></div><p class="sub">（预留）话题详情。</p></div></section>

    <section id="page-reviews-all" class="page"><div class="container-apple py-6"><div class="flex items-center justify-between mb-4"><h3 class="h2">全部院校</h3><button class="btn btn-outline" data-back>返回</button></div><p class="sub">（预留）院校列表搜索页。</p></div></section>
    <section id="page-svc-campus" class="page"><div class="container-apple py-6"><div class="flex items-center justify-between mb-4"><h3 class="h2">学生证/校车</h3><button class="btn btn-outline" data-back>返回</button></div><p class="sub">（预留）校务服务。</p></div></section>
    <section id="page-svc-visa" class="page"><div class="container-apple py-6"><div class="flex items-center justify-between mb-4"><h3 class="h2">签证/居留</h3><button class="btn btn-outline" data-back>返回</button></div><p class="sub">（预留）签证服务。</p></div></section>
    <section id="page-svc-housing" class="page"><div class="container-apple py-6"><div class="flex items-center justify-between mb-4"><h3 class="h2">住宿/租房</h3><button class="btn btn-outline" data-back>返回</button></div><p class="sub">（预留）住宿服务。</p></div></section>
    <section id="page-svc-jobs" class="page"><div class="container-apple py-6"><div class="flex items-center justify-between mb-4"><h3 class="h2">兼职/实习</h3><button class="btn btn-outline" data-back>返回</button></div><p class="sub">（预留）就业服务。</p></div></section>
    <section id="page-membership" class="page"><div class="container-apple py-6"><div class="flex items-center justify-between mb-4"><h3 class="h2">会员中心</h3><button class="btn btn-outline" data-back>返回</button></div><p class="sub">（预留）会员服务。</p></div></section>

    <!-- 新增聊天大厅页面 -->
    <section id="page-trade-chat-lobby" class="page">
      <div class="page-header">
        <button class="btn btn-outline" data-back><i class="fas fa-arrow-left"></i></button>
        <h3 class="h2">交易聊天大厅</h3>
      </div>
      <div class="page-content">
        <div class="chat-tab-bar">
          <div class="chat-tab active" data-tab="trade-active">活跃聊天</div>
          <div class="chat-tab" data-tab="trade-recent">最近聊天</div>
          <div class="chat-tab" data-tab="trade-groups">群组</div>
        </div>
        <div class="chat-lobby">
          <!-- 示例聊天室卡片 -->
          <div class="chat-room-card">
            <div class="chat-room-header">
              <div class="chat-room-avatar">U</div>
              <div class="chat-room-title">二手 iPad 交易</div>
              <span class="chat-room-badge">3</span>
            </div>
            <div class="chat-room-body">
              <div class="chat-room-desc">求购 iPad Pro 11寸 2021款，预算 60万韩元</div>
              <div class="chat-room-meta">
                <span><i class="fa-regular fa-user"></i> 李同学</span>
                <span><i class="fa-regular fa-clock"></i> 2分钟前</span>
              </div>
            </div>
            <div class="chat-room-footer">
              <button class="chat-action-btn" data-open-chat-detail data-room="trade-ipad" data-title="二手 iPad 交易">
                <i class="fa-regular fa-comment"></i> 加入聊天
              </button>
              <span class="text-[#6e6e73] text-sm">在线: 2人</span>
            </div>
          </div>
          
          <div class="chat-room-card">
            <div class="chat-room-header">
              <div class="chat-room-avatar">U</div>
              <div class="chat-room-title">代取快递</div>
            </div>
            <div class="chat-room-body">
              <div class="chat-room-desc">周三下午3点，高丽大学正门快递点</div>
              <div class="chat-room-meta">
                <span><i class="fa-regular fa-user"></i> 张同学</span>
                <span><i class="fa-regular fa-clock"></i> 15分钟前</span>
              </div>
            </div>
            <div class="chat-room-footer">
              <button class="chat-action-btn" data-open-chat-detail data-room="trade-delivery" data-title="代取快递">
                <i class="fa-regular fa-comment"></i> 加入聊天
              </button>
              <span class="text-[#6e6e73] text-sm">在线: 1人</span>
            </div>
          </div>
          
          <div class="chat-room-card">
            <div class="chat-room-header">
              <div class="chat-room-avatar">U</div>
              <div class="chat-room-title">教材转卖</div>
              <span class="chat-room-badge">1</span>
            </div>
            <div class="chat-room-body">
              <div class="chat-room-desc">计算机专业教材，几乎全新，半价出售</div>
              <div class="chat-room-meta">
                <span><i class="fa-regular fa-user"></i> 金同学</span>
                <span><i class="fa-regular fa-clock"></i> 1小时前</span>
              </div>
            </div>
            <div class="chat-room-footer">
              <button class="chat-action-btn" data-open-chat-detail data-room="trade-books" data-title="教材转卖">
                <i class="fa-regular fa-comment"></i> 加入聊天
              </button>
              <span class="text-[#6e6e73] text-sm">在线: 3人</span>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <section id="page-community-chat-lobby" class="page">
      <div class="page-header">
        <button class="btn btn-outline" data-back><i class="fas fa-arrow-left"></i></button>
        <h3 class="h2">社区聊天大厅</h3>
      </div>
      <div class="page-content">
        <div class="chat-tab-bar">
          <div class="chat-tab active" data-tab="community-active">热门话题</div>
          <div class="chat-tab" data-tab="community-study">学习交流</div>
          <div class="chat-tab" data-tab="community-life">生活互助</div>
        </div>
        <div class="chat-lobby">
          <!-- 示例社区聊天室 -->
          <div class="chat-room-card">
            <div class="chat-room-header">
              <div class="chat-room-avatar">U</div>
              <div class="chat-room-title">期末高效复习法</div>
              <span class="chat-room-badge">12</span>
            </div>
            <div class="chat-room-body">
              <div class="chat-room-desc">分享各科高效复习方法，互助备考</div>
              <div class="chat-room-meta">
                <span><i class="fa-regular fa-user"></i> 延世·计算机</span>
                <span><i class="fa-regular fa-comment"></i> 120条讨论</span>
              </div>
            </div>
            <div class="chat-room-footer">
              <button class="chat-action-btn" data-open-topic-chat data-room="topic-exam" data-title="期末高效复习法">
                <i class="fa-regular fa-comment"></i> 加入讨论
              </button>
              <span class="text-[#6e6e73] text-sm">在线: 24人</span>
            </div>
          </div>
          
          <div class="chat-room-card">
            <div class="chat-room-header">
              <div class="chat-room-avatar">U</div>
              <div class="chat-room-title">校内兼职怎么找？</div>
            </div>
            <div class="chat-room-body">
              <div class="chat-room-desc">分享校内兼职信息，避坑指南</div>
              <div class="chat-room-meta">
                <span><i class="fa-regular fa-user"></i> 高丽·商学院</span>
                <span><i class="fa-regular fa-comment"></i> 78条讨论</span>
              </div>
            </div>
            <div class="chat-room-footer">
              <button class="chat-action-btn" data-open-topic-chat data-room="topic-job" data-title="校内兼职怎么找？">
                <i class="fa-regular fa-comment"></i> 加入讨论
              </button>
              <span class="text-[#6e6e73] text-sm">在线: 15人</span>
            </div>
          </div>
          
          <div class="chat-room-card">
            <div class="chat-room-header">
              <div class="chat-room-avatar">U</div>
              <div class="chat-room-title">2025 租房避坑指南</div>
              <span class="chat-room-badge">5</span>
            </div>
            <div class="chat-room-body">
              <div class="chat-room-desc">分享租房经验，避免踩坑</div>
              <div class="chat-room-meta">
                <span><i class="fa-regular fa-user"></i> 首尔·住房</span>
                <span><i class="fa-regular fa-comment"></i> 233条讨论</span>
              </div>
            </div>
            <div class="chat-room-footer">
              <button class="chat-action-btn" data-open-topic-chat data-room="topic-rent" data-title="2025 租房避坑指南">
                <i class="fa-regular fa-comment"></i> 加入讨论
              </button>
              <span class="text-[#6e6e73] text-sm">在线: 42人</span>
            </div>
          </div>
          
          <div class="chat-room-card">
            <div class="chat-room-header">
              <div class="chat-room-avatar">U</div>
              <div class="chat-room-title">韩语学习交流</div>
            </div>
            <div class="chat-room-body">
              <div class="chat-room-desc">一起学习韩语，分享学习资源</div>
              <div class="chat-room-meta">
                <span><i class="fa-regular fa-user"></i> 语言学习</span>
                <span><i class="fa-regular fa-comment"></i> 89条讨论</span>
              </div>
            </div>
            <div class="chat-room-footer">
              <button class="chat-action-btn" data-open-topic-chat data-room="topic-korean" data-title="韩语学习交流">
                <i class="fa-regular fa-comment"></i> 加入讨论
              </button>
              <span class="text-[#6e6e73] text-sm">在线: 18人</span>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <button id="fab" class="fixed bottom-6 right-6 w-14 h-14 rounded-full bg-[var(--brand)] text-white text-xl shadow-xl flex items-center justify-center" aria-label="发布"><i class="fas fa-plus"></i></button>

  <!-- 聊天面板 -->
  <div id="chatPanel" class="chat-panel" role="dialog" aria-modal="true" aria-labelledby="chatRoomTitle">
    <div class="chat-header">
      <div class="flex items-center gap-2"><i class="fa-regular fa-comments"></i><b id="chatRoomTitle">聊天</b></div>
      <div class="flex items-center gap-2"><span id="chatRoomBadge" class="text-xs" style="opacity:.7"></span>
        <button id="closeChatBtn" class="btn btn-outline" style="padding:6px 10px"><i class="fas fa-times"></i></button>
      </div>
    </div>
    <div id="chatMessages" class="chat-body" aria-live="polite"></div>
    <div class="chat-input">
      <input id="chatInput" type="text" placeholder="输入消息，回车发送…" />
      <button id="chatSendBtn" class="btn btn-black">发送</button>
    </div>
  </div>
  
  <button id="chatToggleBtn" class="chat-toggle-btn">
    <i class="fa-regular fa-comments"></i>
    <span id="chatNotification" class="chat-indicator" style="display:none">3</span>
  </button>

  <script>
    /* 可选：填入 Supabase 启用邮箱验证
    window.SUPABASE_URL  = '';
    window.SUPABASE_ANON = '';
    */

    const $$ = s => Array.from(document.querySelectorAll(s));
    const $  = s => document.querySelector(s);

    // ===== 国家 & 院校（可由后端返回覆盖） =====
    const COUNTRIES = ['韩国','美国','英国','日本','澳大利亚','加拿大','德国','法国','荷兰','意大利','西班牙','瑞士','瑞典','新加坡','马来西亚','泰国','俄罗斯','新西兰','爱尔兰','丹麦','挪威','芬兰','比利时','奥地利','葡萄牙','中国香港','中国澳门','中国台湾','以色列','阿联酋','卡塔尔','沙特','印度','印尼','越南','菲律宾','土耳其','希腊','匈牙利','波兰','捷克','斯洛伐克','罗马尼亚','保加利亚'];
    const SCHOOLS_BY_COUNTRY = { '韩国':['嘉泉大学','延世大学','高丽大学','首尔大学','汉阳大学','成均馆大学','梨花女子大学','庆熙大学','又石大学','西江大学','中央大学','弘益大学'], '美国':['Harvard University','MIT','Stanford University','UC Berkeley','UCLA','Columbia University','NYU','Carnegie Mellon University','University of Chicago'] };
    // 修正部分国家/地区的货币映射键名格式
    // 注意：原代码中 "意大利:'€'" 少了一个单引号，导致语法错误。下面修复为 '意大利':'€' 这种形式。
    const currencyByCountry = {
      '韩国': '₩',
      '美国': '$',
      '英国': '£',
      '日本': '¥',
      '澳大利亚': 'A$',
      '加拿大': 'C$',
      '德国': '€',
      '法国': '€',
      '荷兰': '€',
      '意大利': '€',
      '西班牙': '€',
      '瑞士': 'CHF',
      '瑞典': 'kr',
      '新加坡': 'S$',
      '马来西亚': 'RM',
      '泰国': '฿',
      '俄罗斯': '₽',
      '新西兰': 'NZ$',
      '爱尔兰': '€',
      '丹麦': 'kr',
      '挪威': 'kr',
      '芬兰': '€',
      '比利时': '€',
      '奥地利': '€',
      '葡萄牙': '€',
      '中国香港': 'HK$',
      '中国澳门': 'MOP$',
      '中国台湾': 'NT$'
    };
    const SYNC_TIME_LABEL = '20:00（首尔）';

    // ===== 初始化下拉 / 货币联动 =====
    function fillCountrySelect(el){ if(!el) return; el.innerHTML = '<option value="">全部国家/地区</option>' + COUNTRIES.map(c=>`<option value="${c}">${c}</option>`).join(''); }
    fillCountrySelect($('#taskCountryFilter'));
    $('#countrySelect').innerHTML = COUNTRIES.map(c=>`<option value="${c}">${c}</option>`).join('');
    function refreshSchoolList(country){ const dl=$('#schoolList'); const arr=SCHOOLS_BY_COUNTRY[country]||[]; dl.innerHTML=arr.map(n=>`<option value="${n}"></option>`).join(''); }
    function syncCurrency(){ const country=$('#countrySelect').value; $('#currencyUnit').textContent = currencyByCountry[country] || '$'; refreshSchoolList(country); }
    $('#countrySelect')?.addEventListener('change', syncCurrency); syncCurrency();

    // 图片懒加载
    document.querySelectorAll('img').forEach(img=>{img.loading=img.loading||'lazy'; img.decoding=img.decoding||'async'});

    // Mobile tab active
    function setActiveTab(){const hash=location.hash||'#home'; $$('#mobileTabs a').forEach(a=>{const on=(a.getAttribute('href')===hash)||a.hasAttribute('data-page')&&(`#page-${a.getAttribute('data-page')}`===hash); a.classList.toggle('text-black',on); a.classList.toggle('font-semibold',on);});}
    window.addEventListener('hashchange',setActiveTab); setActiveTab();

    // 弹层开关
    const overlay=$('#overlay');
    const sheet=$('#publishSheet');
    const openPublish=()=>{document.body.style.overflow='hidden';overlay.classList.remove('hidden');sheet.classList.remove('hidden');}
    const closePublish=()=>{sheet.classList.add('hidden');overlay.classList.add('hidden');document.body.style.overflow='';}
    $('#fab')?.addEventListener('click',openPublish);
    $('#publishBtnTop')?.addEventListener('click',openPublish);
    $('#publishBtnTrade')?.addEventListener('click',openPublish);
    $('#closePublish')?.addEventListener('click',closePublish);

    // 用户抽屉
    const drawer=$('#userDrawer');
    $('#avatarBtn')?.addEventListener('click',()=>{overlay.classList.remove('hidden');drawer.classList.add('active');});
    $('#closeDrawerBtn')?.addEventListener('click',()=>{overlay.classList.add('hidden');drawer.classList.remove('active');});
    overlay?.addEventListener('click',()=>{
      if(drawer.classList.contains('active')) { overlay.classList.add('hidden'); drawer.classList.remove('active'); return; }
      if(!$('#postDetail').classList.contains('hidden')){ closePostDetail(); overlay.classList.add('hidden'); return; }
      closePublish();
    });

    // 登录逻辑（可接Supabase）
    let supabase=null; if(window.SUPABASE_URL && window.SUPABASE_ANON && window.supabase){ supabase=window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON); }
    const state={ user: JSON.parse(localStorage.getItem('unilink_user')||'null') };
    function lsSet(k,v){localStorage.setItem(k, JSON.stringify(v));}
    function ensureMembership(){ if(!state.user) return; if(!state.user.membership){ state.user.membership={ level:'free', expires_at:null }; lsSet('unilink_user', state.user); } }

    function renderUser(){
      const title=$('#userPanelTitle'), loginBtn=$('#loginBtn'), logoutBtn=$('#logoutBtn'), doLogoutBtn=$('#doLogout');
      const vipBadge=$('#userVipBadge'), vipText=$('#vipText');
      if(state.user){
        ensureMembership();
        const isVip = state.user.membership?.level==='vip' && (!state.user.membership.expires_at || new Date(state.user.membership.expires_at)>new Date());
        title.textContent=`${state.user.wechat||state.user.email}（${state.user.type==='student'?'留学生用户':'其他用户'}）`;
        loginBtn?.classList.add('hidden'); logoutBtn?.classList.remove('hidden'); doLogoutBtn?.classList?.remove('hidden');
        if(isVip){ vipBadge?.classList.remove('hidden'); vipText.textContent = 'VIP · '+ (state.user.membership.expires_at? ('有效期至 '+ new Date(state.user.membership.expires_at).toLocaleDateString()):'永久'); }
        else { vipBadge?.classList.add('hidden'); }
      }else{
        title.textContent='未登录用户';
        loginBtn?.classList.remove('hidden'); logoutBtn?.classList.add('hidden'); doLogoutBtn?.classList?.add('hidden');
        vipBadge?.classList.add('hidden');
      }
      renderMembership();
    }
    function syncAuthFields(){ $('#authEmailWrap').classList.toggle('hidden', !$('#ut_student').checked); }
    $$('#segUserType input').forEach(r=> r.addEventListener('change', syncAuthFields)); syncAuthFields();
    const openAuth=()=>{ overlay.classList.remove('hidden'); $('#authSheet').classList.remove('hidden'); syncAuthFields(); }
    const closeAuth=()=>{ $('#authSheet').classList.add('hidden'); overlay.classList.add('hidden'); }
    $('#loginBtn')?.addEventListener('click', openAuth);
    $('#closeAuth')?.addEventListener('click', closeAuth);

    async function signIn(){
      const isStudent = $('#ut_student').checked;
      const email  = ($('#emailInput')?.value||'').trim();
      const wechat = ($('#wechatInput')?.value||'').trim();
      if(!wechat){ alert('请填写微信号'); return; }
      if(isStudent && !email){ alert('留学生需填写邮箱'); return; }
      if(isStudent && supabase){ try{ await supabase.auth.signInWithOtp({ email, options:{ emailRedirectTo: location.href } }); alert('验证邮件已发送，请查收'); }catch(e){ alert('登录失败：'+(e.message||'未知错误')); return; } }
      state.user={ id:'local-'+Date.now(), email: email||'', wechat, type: isStudent?'student':'other', membership:{ level:'free', expires_at:null } };
      lsSet('unilink_user', state.user); renderUser(); closeAuth();
    }
    async function signOut(){ if(supabase){ try{ await supabase.auth.signOut(); }catch{} } state.user=null; lsSet('unilink_user', null); renderUser(); alert('已退出登录'); }
    $('#doLogin')?.addEventListener('click', signIn);
    $('#logoutBtn')?.addEventListener('click', signOut);
    $('#doLogout')?.addEventListener('click', signOut);
    renderUser();

    // 本地存储
    function loadPosts(){ try{return JSON.parse(localStorage.getItem('unilink_posts')||'[]')}catch{return []} }
    function savePosts(list){ localStorage.setItem('unilink_posts', JSON.stringify(list)); }

    // 发布
    $('#syncTimeLbl').textContent = SYNC_TIME_LABEL;
    $('#publishForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      if(!state.user){ alert('请先登录再发布'); return; }
      const f=e.target;
      const data={
        id:Date.now(), type:f.type.value, price:Number(f.price.value||0),
        title:f.title.value.trim(), desc:f.desc.value.trim(),
        country: f.fcountry.value, school: (f.school?.value||'').trim(),
        campus:f.campus.value.trim(), contact:f.contact.value.trim(),
        urgent: !!f.urgent.checked, created_at:new Date().toISOString(), status:'open'
      };
      const list=loadPosts();
      // VIP 曝光：插到更靠前位置（示例）
      const isVip = state.user?.membership?.level==='vip' && (!state.user.membership.expires_at || new Date(state.user.membership.expires_at)>new Date());
      if(isVip){ list.unshift(data); } else { list.push(data); }
      savePosts(list);
      renderMyPosts(); renderPostsList(); renderTradePosts(); updateTypePages();
      closePublish(); alert('发布成功！'); f.reset(); syncCurrency();
    });

    // 我的发布（抽屉）
    function removePost(id){ const list=loadPosts().filter(p=>p.id!==id); savePosts(list); renderMyPosts(); renderPostsList(); renderTradePosts(); updateTypePages(); }
    function renderMyPosts(){
      const wrap=$('#myPosts'), empty=$('#myPostsEmpty'); const posts=loadPosts();
      if(!wrap) return; if(!posts.length){ empty?.classList.remove('hidden'); wrap.innerHTML=''; return; }
      empty?.classList.add('hidden');
      wrap.innerHTML=posts.map(p=>`<div class="post-item border rounded-lg p-3">
        <div class="flex items-start justify-between gap-2">
          <div>
            <div class="font-semibold">${p.title||'(无标题)'} <span class="text-xs text-[#6e6e73]">${p.type==='errand'?'跑腿/代购':p.type==='market'?'二手转让':'悬赏任务'}</span>${p.urgent?' <span class="ml-1 text-xs text-red-600">紧急</span>':''}</div>
            <div class="text-[#6e6e73] text-[13px] mt-1 line-clamp-2">${p.desc||''}</div>
            <div class="text-[13px] mt-1">${(currencyByCountry[p.country]||'$')+(p.price||0)} · ${p.country}${p.school?(' · '+p.school):''} · ${p.campus||''}</div>
            ${p.urgent?'<div class="help mt-1">⏱ 已标记紧急，将于 '+SYNC_TIME_LABEL+' 自动同步到微信社区</div>':''}
          </div>
          <button class="text-[#6e6e73] hover:text-red-600" aria-label="删除" onclick="(${removePost})(${p.id})"><i class="fa-regular fa-trash-can"></i></button>
        </div>
      </div>`).join('');
    }
    $('#clearMyPosts')?.addEventListener('click', ()=>{ savePosts([]); renderMyPosts(); renderPostsList(); renderTradePosts(); updateTypePages(); });
    renderMyPosts();

    // 院校评价（示例）
    const reviewsData=[{school:'延世大学',major:'计算机科学',course:4,life:4,career:3,score:4.1},{school:'高丽大学',major:'金融工程',course:4,life:4,career:4,score:4.4},{school:'首尔大学',major:'设计学',course:3,life:5,career:4,score:4.3}];
    let sortKey='score', sortDir='desc', query='';
    const tbody=$('#reviewsTbody'); const search=$('#reviewsSearch');
    function stars(n){const full=Math.round(n);return '★★★★★'.slice(0,full)+'☆☆☆☆☆'.slice(0,5-full)}
    function renderReviews(){
      let rows=[...reviewsData];
      if(query){const q=query.toLowerCase(); rows=rows.filter(r=>r.school.toLowerCase().includes(q)||r.major.toLowerCase().includes(q));}
      rows.sort((a,b)=>{const A=a[sortKey],B=b[sortKey]; if(A===B) return 0; return (sortDir==='asc'? (A>B?1:-1):(A<B?1:-1));});
      tbody.innerHTML=rows.map(r=>`<tr class="border-b hover:bg-[#fafafa]"><td class="py-3 px-4">${r.school}</td><td class="py-3 px-4">${r.major}</td><td class="py-3 px-4">${stars(r.course)}</td><td class="py-3 px-4">${stars(r.life)}</td><td class="py-3 px-4">${stars(r.career)}</td><td class="py-3 px-4 font-semibold">${r.score.toFixed(1)}</td></tr>`).join('');
      $$('#reviews thead [data-sort]').forEach(th=>{th.removeAttribute('aria-sort'); if(th.dataset.sort===sortKey){th.setAttribute('aria-sort',sortDir==='asc'?'ascending':'descending');}});
    }
    renderReviews();
    search?.addEventListener('input',e=>{query=e.target.value.trim(); renderReviews();});
    $$('#reviews thead [data-sort]').forEach(th=>th.addEventListener('click',()=>{const key=th.dataset.sort; if(sortKey===key){sortDir=sortDir==='asc'?'desc':'asc';}else{sortKey=key; sortDir='desc';} renderReviews();}));

    // 详情弹窗
    function openPostDetail(id){
      const p=loadPosts().find(x=>x.id===id); if(!p) return;
      $('#postDetail').dataset.id=String(id);
      $('#detailTitle').textContent=p.title||'(无标题)';
      $('#detailType').textContent=(p.type==='errand'?'跑腿/代购':p.type==='market'?'二手转让':'悬赏任务');
      $('#detailDesc').textContent=p.desc||'';
      $('#detailPrice').textContent=(currencyByCountry[p.country]||'$')+(p.price||0);
      $('#detailCountry').textContent=p.country||'';
      $('#detailSchool').textContent=p.school||'';
      $('#detailCampus').textContent=p.campus||'';
      $('#detailContact').textContent=p.contact||'';
      document.body.style.overflow='hidden'; overlay.classList.remove('hidden'); $('#postDetail').classList.remove('hidden');
    }
    function closePostDetail(){ $('#postDetail').classList.add('hidden'); document.body.style.overflow=''; }
    $('#closeDetail')?.addEventListener('click',()=>{ closePostDetail(); overlay.classList.add('hidden'); });
    document.addEventListener('click',(e)=>{
      const btn=e.target.closest('[data-open-detail]'); if(btn){ openPostDetail(Number(btn.getAttribute('data-open-detail'))); }
      const card=e.target.closest('#tradeMyPosts [data-id]'); if(card){ openPostDetail(Number(card.dataset.id)); }
      const pageBtn=e.target.closest('[data-page]'); if(pageBtn){ openPage(pageBtn.getAttribute('data-page')); }
      const backBtn=e.target.closest('[data-back]'); if(backBtn){ closePage(); }
    });
    $('#copyContact')?.addEventListener('click',()=>{ const txt=$('#detailContact').textContent||''; navigator.clipboard?.writeText(txt).then(()=>alert('已复制联系方式')); });
    $('#markDone')?.addEventListener('click',()=>{ const id=Number($('#postDetail').dataset.id); if(!id) return; const list=loadPosts(); const idx=list.findIndex(p=>p.id===id); if(idx>-1){ list[idx].status='done'; savePosts(list); } closePostDetail(); overlay.classList.add('hidden'); renderTradePosts(); renderPostsList(); updateTypePages(); });

    // 列表渲染（主页两块）
    function renderTradePosts(){
      const box=$('#tradeMyPosts'), empty=$('#tradeMyPostsEmpty'); const list=loadPosts();
      if(!list.length){ box.innerHTML=''; empty?.classList.remove('hidden'); return; }
      empty?.classList.add('hidden');
      box.innerHTML=list.slice(0,8).map(p=>`<article class="tile p-5 cursor-pointer" data-id="${p.id}">
        <div class="text-xs text-[#6e6e73]">${p.type==='errand'?'跑腿/代购':p.type==='market'?'二手转让':'悬赏任务'} · ${new Date(p.created_at).toLocaleDateString()}${p.status==='done'?' · 已完成':''}${p.urgent?' · 紧急':''}</div>
        <h4 class="font-semibold mt-1 line-clamp-1">${p.title||'(无标题)'}</h4>
        <div class="text-[14px] mt-1 line-clamp-2">${p.desc||''}</div>
        <div class="text-[14px] mt-2">${(currencyByCountry[p.country]||'$')+(p.price||0)} · ${p.country}${p.school?(' · '+p.school):''}</div>
      </article>`).join('');
    }

    function renderPostsList(){
      const wrap=$('#postsList'); const list=loadPosts(); if(!wrap) return;
      if(!list.length){ wrap.innerHTML='<div class="text-[#6e6e73]">暂无用户发布</div>'; return; }
      wrap.innerHTML=list.slice(0,9).map(p=>`<div class="tile p-4 flex flex-col justify-between">
        <div>
          <div class="font-semibold mb-1 flex items-center gap-2">${p.title}${p.vip?' <span class=\"text-xs text-yellow-600\">VIP</span>':''}</div>
          <div class="text-[14px] text-[#6e6e73] mb-2">${p.type==='errand'?'跑腿/代购':p.type==='market'?'二手转让':'悬赏任务'} · ${(currencyByCountry[p.country]||'$')+p.price}${p.urgent?' · <span class="text-red-600">紧急</span>':''}</div>
          <div class="text-[14px] line-clamp-2 mb-2">${p.desc}</div>
          <div class="text-[13px] text-[#6e6e73]">${p.country}${p.school?(' · '+p.school):''} · ${p.campus||''}</div>
        </div>
        <button class="btn btn-outline mt-3" data-open-detail="${p.id}">查看详情</button>
      </div>`).join('');
    }

    // 页面路由
    let currentPage=null; const pageHistory=[];
    function openPage(pageId){ const pageDom=document.getElementById(`page-${pageId}`); if(!pageDom) return; pageHistory.push(pageId); pageDom.classList.add('active'); currentPage=pageId; document.body.style.overflow='hidden'; updateTypePages(); if(pageId==='membership'){ renderMembershipPage(); } }
    function closePage(){ if(pageHistory.length===0) return; pageHistory.pop(); const pageDom=document.getElementById(`page-${currentPage}`); if(pageDom){ pageDom.classList.remove('active'); } if(pageHistory.length===0){ currentPage=null; document.body.style.overflow=''; } else { currentPage=pageHistory[pageHistory.length-1]; document.getElementById(`page-${currentPage}`).classList.add('active'); } }

    function renderTypeList(type, containerSel){
      const el = $(containerSel); if(!el) return; const q = $('#taskSearch')?.value?.trim()?.toLowerCase()||''; const ctry=$('#taskCountryFilter')?.value||'';
      const list = loadPosts().filter(p=>p.type===type).filter(p=> !ctry || p.country===ctry).filter(p=> !q || p.title.toLowerCase().includes(q) || p.desc.toLowerCase().includes(q));
      if(!list.length){ el.innerHTML = '<div class="text-[#6e6e73]">暂无相关发布</div>'; return; }
      el.innerHTML = list.map(p=>`<div class="tile p-4">
        <div class="text-xs text-[#6e6e73]">${new Date(p.created_at).toLocaleString()}${p.urgent?' · 紧急':''}</div>
        <div class="font-semibold mt-1 flex items-center gap-2">${p.title}${p.vip?' <span class=\"text-xs text-yellow-600\">VIP</span>':''}</div>
        <div class="text-[14px] mt-1 line-clamp-2">${p.desc}</div>
        <div class="text-[14px] mt-2">${(currencyByCountry[p.country]||'$')+(p.price||0)} · ${p.country}${p.school?(' · '+p.school):''} · ${p.campus||''}</div>
        <div class="mt-3 flex gap-2">
          <button class="btn btn-outline flex-1" data-open-detail="${p.id}">查看</button>
          <button class="btn btn-black flex-1" onclick="navigator.clipboard?.writeText('${p.contact||''}').then(()=>alert('已复制联系方式'))">联系</button>
        </div>
      </div>`).join('');
    }

    function updateTypePages(){ renderTypeList('task', '#taskList'); renderTypeList('errand', '#errandsList'); renderTypeList('market', '#marketList'); renderTypeList('groupbuy', '#groupbuyList'); }

    $('#taskCountryFilter')?.addEventListener('change', ()=>{ updateTypePages(); });
    $('#taskSearch')?.addEventListener('input', ()=>{ updateTypePages(); });
    $('#publishTaskBtn')?.addEventListener('click', ()=>{ openPublish(); document.querySelector('#publishForm select[name=type]').value='task'; });

    // 会员中心逻辑
    function renderMembershipPage(){
      if(!state.user){ $('#memLevelText').textContent='未登录'; $('#memExpireText').textContent='请先登录'; return; }
      ensureMembership();
      const m = state.user.membership; const now = new Date();
      const valid = m.level==='vip' && (!m.expires_at || new Date(m.expires_at)>now);
      $('#memLevelText').textContent = valid? 'VIP' : 'Free';
      $('#memExpireText').textContent = valid && m.expires_at ? ('有效期至 '+ new Date(m.expires_at).toLocaleString()) : (valid? '长期有效' : '—');
      $('#vipUpgradeBtn')?.classList.toggle('hidden', valid);
    }
    
    function renderMembership(){
      const level = document.getElementById('memberLevelText');
      const badge = document.getElementById('memberBadge');
      const expire= document.getElementById('memberExpire');
      const upgradeBtn = document.getElementById('btnUpgradeVIP');
      const downgradeBtn = document.getElementById('btnDowngrade');
      
      if(!state.user){ 
        level.textContent = 'Free（普通用户）';
        badge.style.display = 'none';
        expire.textContent = '到期时间：—';
        upgradeBtn.style.display = 'block';
        downgradeBtn.style.display = 'none';
        return;
      }
      
      ensureMembership();
      const m = state.user.membership; 
      const now = new Date();
      const valid = m.level==='vip' && (!m.expires_at || new Date(m.expires_at)>now);
      
      level.textContent = valid ? 'VIP（尊享会员）' : 'Free（普通用户）';
      badge.style.display = valid ? 'inline-flex' : 'none';
      expire.textContent = valid && m.expires_at ? ('到期时间：'+new Date(m.expires_at).toLocaleDateString()) : '到期时间：—';
      upgradeBtn.style.display = valid ? 'none' : 'block';
      downgradeBtn.style.display = valid ? 'block' : 'none';
    }
    
    $('#btnUpgradeVIP')?.addEventListener('click', ()=>{
      if(!state.user){ alert('请先登录'); return; }
      const expire = new Date(); expire.setDate(expire.getDate()+30);
      state.user.membership={ level:'vip', expires_at: expire.toISOString() };
      lsSet('unilink_user', state.user); 
      renderUser(); 
      alert('已开通 VIP 试用 30 天');
    });
    
    $('#btnDowngrade')?.addEventListener('click', ()=>{
      if(!state.user) return;
      state.user.membership={ level:'free', expires_at: null };
      lsSet('unilink_user', state.user);
      renderUser();
      alert('已取消 VIP');
    });

    // 初始渲染
    renderTradePosts(); renderPostsList(); updateTypePages();

    // ESC 关闭
    window.addEventListener('keydown',(e)=>{
      if(e.key!=='Escape') return;
      if(currentPage){ closePage(); return; }
      if(!$('#postDetail').classList.contains('hidden')){ closePostDetail(); overlay.classList.add('hidden'); return; }
      closePublish();
    });

    // 刷新按钮
    $('#refreshPosts')?.addEventListener('click', ()=>{ renderPostsList(); });

    // ===== 聊天系统实现 =====
    (function(){
      // 工具函数
      const jget=(k,def)=>{ try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(def))}catch{return def} };
      const jset=(k,v)=>localStorage.setItem(k, JSON.stringify(v));

      // 聊天状态 (仅本地; 服务端 TODO)
      const CHAT_KEY='unilink_chats_v2';
      const loadChats=()=>jget(CHAT_KEY,{});
      const saveChats=(v)=>jset(CHAT_KEY,v);

      const chatPanel=$('#chatPanel'), chatList=$('#chatMessages'), chatTitle=$('#chatRoomTitle'), chatBadge=$('#chatRoomBadge'), chatInput=$('#chatInput');
      const chatToggleBtn=$('#chatToggleBtn'), chatNotification=$('#chatNotification');
      const chatState={ roomId:'global', title:'全站群聊', msgs:[] };

      function renderChat(){
        chatList.innerHTML = (chatState.msgs||[]).map(m=>{
          const u = jget('unilink_user',null);
          const me = u && m.uid === (u.id||'');
          return `
            <div class="chat-item ${me?'chat-me':''}"><div class="chat-bubble">${(m.text||'').replace(/</g,'&lt;')}</div></div>
            <div class="chat-item ${me?'chat-me':''}"><div class="chat-meta">${new Date(m.ts).toLocaleString()} · ${me?'我':(m.uname||'对方')}</div></div>`;
        }).join('');
        chatList.scrollTop = chatList.scrollHeight;
        
        // 更新通知计数
        updateNotificationCount();
      }

      function openChat(roomId,title){
        const all=loadChats(); 
        chatState.roomId=roomId; 
        chatState.title=title; 
        chatState.msgs=all[roomId]||[];
        
        chatTitle.textContent=title; 
        chatBadge.textContent=`房间ID：${roomId}`;
        chatPanel.classList.add('active'); 
        renderChat(); 
        chatInput?.focus();
        
        // 清除该房间的通知
        clearRoomNotification(roomId);
      }
      
      function closeChat(){ 
        chatPanel.classList.remove('active'); 
      }
      
      function sendMsg(){
        const text=(chatInput.value||'').trim(); 
        if(!text) return;
        
        let user = jget('unilink_user',null);
        if(!user){ alert('请先登录再发言'); return; }
        
        const msg={ 
          uid:user.id||'', 
          uname:user.wechat||user.email||'用户', 
          text, 
          ts:Date.now() 
        };
        
        const all=loadChats(); 
        const arr=all[chatState.roomId]||[]; 
        arr.push(msg); 
        all[chatState.roomId]=arr; 
        saveChats(all);
        
        chatState.msgs=arr; 
        chatInput.value=''; 
        renderChat();
        
        // TODO: 推送到服务端 (Supabase Realtime / WebSocket)
      }
      
      function updateNotificationCount(){
        const all = loadChats();
        let total = 0;
        
        // 计算所有房间的未读消息
        Object.keys(all).forEach(roomId => {
          if(roomId !== chatState.roomId) {
            total += all[roomId].length;
          }
        });
        
        if(total > 0) {
          chatNotification.textContent = total > 99 ? '99+' : total;
          chatNotification.style.display = 'flex';
        } else {
          chatNotification.style.display = 'none';
        }
      }
      
      function clearRoomNotification(roomId){
        // 实现清除特定房间通知的逻辑
        updateNotificationCount();
      }

      // 绑定事件
      chatToggleBtn?.addEventListener('click',()=>openChat('global','全站群聊'));
      $('#chatSendBtn')?.addEventListener('click',sendMsg);
      chatInput?.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); sendMsg(); }});
      $('#closeChatBtn')?.addEventListener('click',closeChat);

      // 从详情页打开聊天
      document.addEventListener('click',(e)=>{
        const btn=e.target.closest('#openChatFromDetail,[data-open-chat-detail]');
        if(btn){
          // 尝试读取当前详情页的ID/标题
          let rid='trade-post', title='交易聊天';
          const modal=document.querySelector('#detailModal, #postDetail');
          if(modal){
            const id = modal.getAttribute('data-id') || modal.dataset.id || '';
            rid = `trade-post-${id||'unknown'}`;
            const t = document.querySelector('#detailTitle'); 
            if(t) title = `交易聊天 · ${t.textContent.trim()}`;
          }
          openChat(rid, title);
        }
      });

      // 从话题打开聊天
      document.addEventListener('click',(e)=>{
        const b=e.target.closest('[data-open-topic-chat]');
        if(b){ 
          openChat(
            b.getAttribute('data-room'), 
            b.getAttribute('data-title')||'社区聊天'
          ); 
        }
      });
      
      // 聊天大厅标签切换
      document.querySelectorAll('.chat-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.chat-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          // 这里可以添加切换不同标签内容的逻辑
        });
      });
      
      // 初始化通知计数
      updateNotificationCount();
    })();
  </script>
</body>
</html>